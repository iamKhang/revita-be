@startuml Patient Profile Sequence Diagram
!theme plain

actor "Doctor" as D
actor "Patient" as P
boundary "Frontend" as F
control "PatientProfileController" as C
control "PatientProfileService" as PS
entity "PatientProfile" as PP
entity "Patient" as PAT

D -> F: Create new patient profile
F -> C: POST /patient-profile/create-independent
note right: CreateIndependentPatientProfileDto
C -> C: validateCreateIndependentPatientProfileDto(dto)
C -> PS: createIndependent(createIndependentPatientProfileDto, user)
PS -> PS: checkStaffPermission(user)

alt Has permission
  PS -> PP: createIndependentProfile(profileData)
  PP -> PP: prisma.patientProfile.create()
  PP --> PS: patientProfile\n(new patient profile with generated code)
  PS --> C: response\n(created patient profile details)
  C --> F: response\n(patient profile data)
  F --> D: Display success message
  
else No permission
  PS --> C: throw ForbiddenException()
  C --> F: error\n(insufficient permissions message)
  F --> D: Display permission error
end

P -> F: Create patient profile
F -> C: POST /patient-profile/create
note right: CreatePatientProfileDto
C -> C: validateCreatePatientProfileDto(dto)
C -> PS: create(createPatientProfileDto, user)
PS -> PAT: validatePatientExists(user.id)
PAT -> PAT: prisma.patient.findUnique()
PAT --> PS: patient\n(patient account info)

PS -> PS: checkSelfCreationPermission(user, patientId)

alt Has permission
  PS -> PP: createPatientProfile(profileData)
  PP -> PP: prisma.patientProfile.create()
  PP --> PS: patientProfile\n(new patient profile linked to patient)
  PS --> C: response\n(created patient profile with relationships)
  C --> F: response\n(patient profile data)
  F --> P: Display success message
  
else No permission
  PS --> C: throw ForbiddenException()
  C --> F: error\n(permission denied message)
  F --> P: Display permission error
end

D -> F: View profiles list
F -> C: GET /patient-profile
C -> C: validateRequest()
C -> PS: findAll(user)
PS -> PS: checkViewPermission(user)
PS -> PP: findByPermission(user)
PP -> PP: prisma.patientProfile.findMany()
PP --> PS: patientProfiles\n(accessible patient profiles)
PS --> C: response\n(patient profiles list with patient info)
C --> F: response\n(patient profiles array)
F --> D: Display profiles list

@enduml