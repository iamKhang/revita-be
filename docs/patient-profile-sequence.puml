@startuml Patient Profile Sequence Diagram
!theme plain
title Tương Tác Tạo và Xem Hồ Sơ Bệnh Nhân - Luồng Bác Sĩ và Bệnh Nhân

actor "Bác Sĩ" as D
actor "Bệnh Nhân" as P
boundary "Giao Diện" as F
control "PatientProfileController" as C
control "PatientProfileService" as PS
entity "PatientProfile" as PP
entity "Patient" as PAT

== Bác sĩ tạo hồ sơ bệnh nhân độc lập ==

D -> F: Tạo hồ sơ bệnh nhân mới
F -> C: POST /patient-profile/create-independent
C -> C: validateCreateIndependentPatientProfileDto(dto)
C -> PS: createIndependent(createIndependentPatientProfileDto, user)
PS -> PS: checkStaffPermission(user)

alt Có quyền tạo
  PS -> PP: createIndependentProfile(profileData)
  PP -> PP: prisma.patientProfile.create()
  PP --> PS: Trả về hồ sơ mới
  PS --> C: Trả về hồ sơ đã tạo
  C --> F: Trả về kết quả tạo hồ sơ
  F --> D: Hiển thị thông báo tạo thành công
  
else Không có quyền
  PS --> C: throw new ForbiddenException()
  C --> F: Thông báo lỗi
  F --> D: Hiển thị thông báo không có quyền
end

== Bệnh nhân tạo hồ sơ cho chính mình ==

P -> F: Tạo hồ sơ bệnh nhân
F -> C: POST /patient-profile/create
C -> C: validateCreatePatientProfileDto(dto)
C -> PS: create(createPatientProfileDto, user)
PS -> PAT: validatePatientExists(user.id)
PAT -> PAT: prisma.patient.findUnique()
PAT --> PS: Xác nhận bệnh nhân hợp lệ

PS -> PS: checkSelfCreationPermission(user, patientId)

alt Có quyền tạo
  PS -> PP: createPatientProfile(profileData)
  PP -> PP: prisma.patientProfile.create()
  PP --> PS: Trả về hồ sơ mới
  PS --> C: Trả về hồ sơ đã tạo
  C --> F: Trả về kết quả tạo hồ sơ
  F --> P: Hiển thị thông báo tạo thành công
  
else Không có quyền
  PS --> C: throw new ForbiddenException()
  C --> F: Thông báo lỗi
  F --> P: Hiển thị thông báo không có quyền
end

== Xem hồ sơ bệnh nhân ==

D -> F: Xem danh sách hồ sơ
F -> C: GET /patient-profile
C -> C: validateRequest()
C -> PS: findAll(user)
PS -> PS: checkViewPermission(user)
PS -> PP: findByPermission(user)
PP -> PP: prisma.patientProfile.findMany()
PP --> PS: Trả về danh sách hồ sơ
PS --> C: Trả về danh sách hồ sơ
C --> F: Trả về kết quả
F --> D: Hiển thị danh sách hồ sơ

@enduml
