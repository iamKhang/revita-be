@startuml cashPaymentSequence

actor "Thu ngân" as Cashier

boundary "Thu ngân UI" as UI
control "InvoicePaymentController" as Controller
entity "InvoicePaymentService" as Service
entity "RoutingService" as Routing
entity "WebSocketService" as WS
entity "Prescription" as Prescription
entity "Invoice" as Invoice
entity "InvoiceDetail" as InvoiceDetail
entity "PrescriptionService" as PrescriptionService

Cashier -> UI: Quét mã phiếu chỉ định
activate UI

UI -> Controller: POST /invoice-payments/scan\nprescriptionCode
activate Controller

Controller -> Service: scanPrescription(prescriptionCode)
activate Service

Service -> Prescription: findFirst(prescriptionCode)
activate Prescription
Prescription --> Service: Prescription
deactivate Prescription

Service -> Service: validateStatus(status != CANCELLED)

Service --> Controller: PrescriptionDetails
deactivate Service

Controller --> UI: 200 OK prescription details
deactivate Controller

UI --> Cashier: Hiển thị danh sách dịch vụ\nvà giá từng dịch vụ
deactivate UI

loop Chọn dịch vụ và xem tổng tiền
    Cashier -> UI: Tích/bỏ tích dịch vụ
    activate UI
    
    UI -> Controller: POST /invoice-payments/preview\nprescriptionCode, selectedServiceIds
    activate Controller
    
    Controller -> Service: createPaymentPreview\n(prescriptionCode, selectedServiceIds)
    activate Service
    
    Service -> Service: filterSelectedServices(selectedIds)
    Service -> Service: calculateTotalAmount(services)
    
    Service --> Controller: PaymentPreview  totalAmount
    deactivate Service
    
    Controller --> UI: 200 OK preview
    deactivate Controller
    
    UI --> Cashier: Hiển thị tổng tiền
    deactivate UI
end

Cashier -> UI: Chọn CASH và nhấn Tạo hóa đơn
activate UI

UI -> Controller: POST /invoice-payments/create\nprescriptionCode, selectedServiceIds,\npaymentMethod CASH
activate Controller

Controller -> Controller: extractCashierIdFromJWT()

    Controller -> Service: createPayment(prescriptionCode,\nselectedServiceIds, paymentMethod,\ncashierId\nn
activate Service

Service -> Service: createPaymentPreview()
Service -> Service: generateInvoiceCode()

Service -> Invoice: create(invoiceCode, patientProfileId,\ncashierId,\ntotalAmount, paymentMethod)
activate Invoice
Invoice --> Service: Invoice created  id
deactivate Invoice

Service -> InvoiceDetail: createMany(invoiceDetails)
activate InvoiceDetail
InvoiceDetail --> Service: InvoiceDetails created
deactivate InvoiceDetail

Service --> Controller: PaymentResult  invoiceCode, isPaid false
deactivate Service

Controller --> UI: 200 OK payment created
deactivate Controller

UI --> Cashier: Hiển thị hóa đơn\nchờ thanh toán
deactivate UI

Cashier -> Cashier: Đếm tiền\nTính tiền thừa

alt Có tiền thừa
end

Cashier -> UI: Nhấn Xác nhận thanh toán
activate UI

UI -> Controller: POST /invoice-payments/confirm\ninvoiceCode
activate Controller

Controller -> Controller: extractCashierIdFromJWT()

Controller -> Service: confirmPayment(invoiceCode, cashierId)
activate Service

Service -> Invoice: findFirst(invoiceCode)
activate Invoice
Invoice --> Service: Invoice data
deactivate Invoice

Service -> Service: validateNotPaid(isPaid)

Service -> Invoice: update(id, isPaid, paymentStatus,\namountPaid, changeAmount)
activate Invoice
Invoice --> Service: Invoice updated
deactivate Invoice

Service -> PrescriptionService: updateMany(prescriptionId,\nserviceIds, status)
activate PrescriptionService
PrescriptionService --> Service: PrescriptionServices updated
deactivate PrescriptionService

Service -> Routing: assignPatientToRooms(patientProfileId,\nserviceIds)
activate Routing
Routing --> Service: routingAssignments \n roomCode, boothCode, doctorId
deactivate Routing

Service -> WS: notifyCashierInvoicePaymentSuccess(\ncashierId, invoice)
activate WS
WS -> WS: broadcastToClinicRooms\n(routingAssignments)
deactivate WS

Service --> Controller: PaymentResult \n isPaid true,\nroutingAssignments
deactivate Service

Controller --> UI: 200 OK payment confirmed
deactivate Controller

UI --> Cashier: Hiển thị thanh toán\nthành công
deactivate UI

Cashier -> UI: In hóa đơn
activate UI
UI -> UI: generateInvoicePDF(invoiceCode)
UI --> Cashier: Hóa đơn in ra
deactivate UI

@enduml


