@startuml cashPaymentSequence

actor "Thu ngân" as Cashier
actor "Bệnh nhân" as Patient

boundary "Thu ngân UI" as UI
control "InvoicePaymentController" as Controller
entity "InvoicePaymentService" as Service
entity "RoutingService" as Routing
entity "WebSocketService" as WS
database "PostgreSQL" as DB

Cashier -> Patient: Yêu cầu phiếu chỉ định
activate Patient
Patient -> Cashier: Đưa phiếu chỉ định
deactivate Patient

Cashier -> UI: Quét mã phiếu chỉ định
activate UI

UI -> Controller: POST /invoice-payments/scan\nprescriptionCode
activate Controller

Controller -> Service: scanPrescription(dto)
activate Service

Service -> DB: SELECT prescription\nWHERE prescriptionCode\nINCLUDE patientProfile, doctor, services
activate DB
DB --> Service: Prescription data
deactivate DB

Service -> Service: Validate status not CANCELLED

Service --> Controller: PrescriptionDetails\npatientProfile, services, prices
deactivate Service

Controller --> UI: 200 OK prescription details
deactivate Controller

UI --> Cashier: Hiển thị danh sách dịch vụ\nvà giá từng dịch vụ
deactivate UI

loop Chọn dịch vụ và xem tổng tiền
    Cashier -> UI: Tích/bỏ tích dịch vụ
    activate UI
    
    UI -> Controller: POST /invoice-payments/preview\nprescriptionCode, selectedServiceIds
    activate Controller
    
    Controller -> Service: createPaymentPreview(dto)
    activate Service
    
    Service -> Service: Lọc selectedServices
    Service -> Service: Calculate totalAmount
    
    Service --> Controller: PaymentPreview\nselectedServices, totalAmount
    deactivate Service
    
    Controller --> UI: 200 OK preview
    deactivate Controller
    
    UI --> Cashier: Hiển thị tổng tiền
    deactivate UI
end

Cashier -> UI: Chọn CASH và nhấn Tạo hóa đơn
activate UI

UI -> Controller: POST /invoice-payments/create\nprescriptionCode, selectedServiceIds,\npaymentMethod CASH
activate Controller

Controller -> Controller: Lấy cashierId từ JWT

Controller -> Service: createPayment(dto)
activate Service

Service -> Service: Tạo preview để validate

Service -> Service: Generate invoiceCode

Service -> DB: BEGIN TRANSACTION
activate DB

Service -> DB: INSERT INTO invoice\ninvoiceCode, patientProfileId,\ncashierId, totalAmount,\npaymentMethod CASH,\nisPaid false
DB --> Service: Invoice created

Service -> DB: INSERT INTO invoiceDetail\ncho từng selectedService
DB --> Service: InvoiceDetails created

Service -> DB: COMMIT TRANSACTION
deactivate DB

Service --> Controller: PaymentResult\ninvoice, isPaid false
deactivate Service

Controller --> UI: 200 OK payment created
deactivate Controller

UI --> Cashier: Hiển thị hóa đơn\nchờ thanh toán
deactivate UI

Cashier -> Patient: Thông báo số tiền\ncần thanh toán
activate Patient

Patient -> Cashier: Đưa tiền mặt
deactivate Patient

Cashier -> Cashier: Đếm tiền\nTính tiền thừa

alt Có tiền thừa
    Cashier -> Patient: Trả tiền thừa
    activate Patient
    Patient -> Patient: Nhận tiền thừa
    deactivate Patient
end

Cashier -> UI: Nhấn Xác nhận thanh toán
activate UI

UI -> Controller: POST /invoice-payments/confirm\ninvoiceCode
activate Controller

Controller -> Controller: Lấy cashierId từ JWT

Controller -> Service: confirmPayment(dto)
activate Service

Service -> DB: SELECT invoice\nWHERE invoiceCode
activate DB
DB --> Service: Invoice data
deactivate DB

Service -> Service: Validate isPaid false

Service -> DB: BEGIN TRANSACTION
activate DB

Service -> DB: UPDATE invoice\nSET isPaid true,\npaidAt now,\nstatus PAID
DB --> Service: Invoice updated

Service -> DB: UPDATE prescription\nSET status PAID
DB --> Service: Prescription updated

Service -> DB: COMMIT TRANSACTION
deactivate DB

Service -> Routing: Tạo routing assignments\ncho các dịch vụ
activate Routing
Routing -> DB: INSERT routing assignments
activate DB
DB --> Routing: Assignments created
deactivate DB
Routing --> Service: routingAssignments
deactivate Routing

Service -> WS: Gửi notification\nđến phòng khám
activate WS
WS -> WS: Broadcast to clinic rooms
deactivate WS

Service --> Controller: PaymentResult\nisPaid true, routingAssignments
deactivate Service

Controller --> UI: 200 OK payment confirmed
deactivate Controller

UI --> Cashier: Hiển thị thanh toán\nthành công
deactivate UI

Cashier -> UI: In hóa đơn
activate UI
UI -> UI: Generate invoice PDF
UI --> Cashier: Hóa đơn in ra
deactivate UI

Cashier -> Patient: Trao hóa đơn
activate Patient

Cashier -> Patient: Hướng dẫn đến phòng khám
deactivate Patient

@enduml


