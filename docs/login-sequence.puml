@startuml Login Sequence Diagram
!theme plain

actor "User" as U
boundary "Frontend" as F
control "LoginController" as C
control "LoginService" as L
entity "Account" as A
entity "Patient" as P
entity "Doctor" as D
entity "Receptionist" as R
entity "Admin" as AD

U -> F: Enter login credentials
F -> C: POST /login
note right: LoginDto
C -> C: validateLoginDto(loginDto)
C -> L: login(loginDto)
L -> L: validateUser(phoneOrEmail, password)
L -> A: findByPhoneOrEmail(phoneOrEmail)
A -> A: prisma.auth.findFirst()
A --> L: auth\n(account record with hashed password)

L -> L: bcrypt.compare(password, auth.password)
alt Password correct
  L -> A: getUserById(auth.id)
  A -> A: prisma.auth.findUnique()
  A --> L: user\n(account details with role)
  
  L -> L: createJwtPayload(user)
  L -> L: addRoleSpecificInfo(user)
  
  alt Role is PATIENT
    L -> P: getPatientByUserId(user.id)
    P -> P: prisma.patient.findUnique()
    P --> L: patient\n(patient profile info)
    
  else Role is DOCTOR
    L -> D: getDoctorByUserId(user.id)
    D -> D: prisma.doctor.findUnique()
    D --> L: doctor\n(doctor profile with specialty)
    
  else Role is RECEPTIONIST
    L -> R: getReceptionistByUserId(user.id)
    R -> R: prisma.receptionist.findUnique()
    R --> L: receptionist\n(receptionist profile info)
    
  else Role is ADMIN
    L -> AD: getAdminByUserId(user.id)
    AD -> AD: prisma.admin.findUnique()
    AD --> L: admin\n(admin profile info)
  end
  
  L -> L: jwt.sign(payload, secret, {expiresIn: '15d'})
  L --> C: response\n(jwt token + user info + role-specific data)
  C --> F: response\n(login success with access token)
  F --> U: Display success and redirect
  
else Password incorrect
  L --> C: throw UnauthorizedException()
  C --> F: error\n(invalid credentials message)
  F --> U: Display login error
end

@enduml