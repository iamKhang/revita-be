@startuml Login Sequence Diagram
!theme plain
title Tương Tác Đăng Nhập Hệ Thống

actor "Người Dùng" as U
boundary "Giao Diện" as F
control "LoginController" as C
control "LoginService" as L
entity "Account" as A
entity "Patient" as P
entity "Doctor" as D
entity "Receptionist" as R
entity "Admin" as AD

== Đăng nhập thông thường ==

U -> F: Nhập thông tin đăng nhập
F -> C: POST /login
C -> C: validateLoginDto(loginDto)
C -> L: login(loginDto)
L -> L: validateUser(phoneOrEmail, password)
L -> A: findByPhoneOrEmail(phoneOrEmail)
A -> A: prisma.account.findFirst()
A --> L: Trả về account record

L -> L: bcrypt.compare(password, account.password)
alt Mật khẩu đúng
  L -> A: getUserById(account.userId)
  A -> A: prisma.account.findUnique()
  A --> L: Trả về thông tin user
  
  L -> L: createJwtPayload(user)
  L -> L: addRoleSpecificInfo(user)
  
  alt Role là PATIENT
    L -> P: getPatientByUserId(user.id)
    P -> P: prisma.patient.findUnique()
    P --> L: Trả về patient info
    
  else Role là DOCTOR
    L -> D: getDoctorByUserId(user.id)
    D -> D: prisma.doctor.findUnique()
    D --> L: Trả về doctor info
    
  else Role là RECEPTIONIST
    L -> R: getReceptionistByUserId(user.id)
    R -> R: prisma.receptionist.findUnique()
    R --> L: Trả về receptionist info
    
  else Role là ADMIN
    L -> AD: getAdminByUserId(user.id)
    AD -> AD: prisma.admin.findUnique()
    AD --> L: Trả về admin info
  end
  
  L -> L: jwt.sign(payload, secret, {expiresIn: '15d'})
  L --> C: Trả về token và user info
  C --> F: Trả về kết quả đăng nhập
  F --> U: Hiển thị thông báo thành công và chuyển trang
  
else Mật khẩu sai
  L --> C: throw new UnauthorizedException()
  C --> F: Thông báo lỗi
  F --> U: Hiển thị thông báo lỗi đăng nhập
end



@enduml
