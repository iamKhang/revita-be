@startuml Medication Prescription Sequence Diagram
!theme plain
title Medication Prescription Sequence

actor "Doctor" as D
boundary "Frontend" as F
control "MedicationPrescriptionController" as C
control "MedicationPrescriptionService" as M
control "DrugCatalogService" as DC
entity "MedicationPrescription" as MP
entity "PatientProfile" as PP
entity "MedicalRecord" as MR
entity "Drug" as DR

== Doctor Creates Prescription ==

D -> F: Select patient and create prescription
F -> C: POST /medication-prescription/create
note right: CreateMedicationPrescriptionDto
C -> C: validateCreateMedicationPrescriptionDto(dto)
C -> M: create(createMedicationPrescriptionDto)
M -> M: validateItemsNotEmpty(items)

alt Items valid
  M -> M: generatePrescriptionCode()
  M -> MP: createPrescription(prescriptionData)
  MP -> MP: prisma.medicationPrescription.create()
  MP --> M: prescription\n(new prescription with status DRAFT)
  
  M -> MP: createPrescriptionItems(prescriptionId, items)
  MP -> MP: prisma.medicationPrescriptionItem.createMany()
  MP --> M: items\n(prescription items with dosage info)
  MP --> M: fullPrescription\n(complete prescription with all items)
  
  M --> C: response\n(prescription with items and patient info)
  C --> F: response\n(created prescription data)
  F --> D: Display success message
  
else Items empty
  M --> C: throw BadRequestException()
  C --> F: error\n(no items provided message)
  F --> D: Display error message
end

== Search Drugs to Add ==

D -> F: Search drugs in catalog
F -> C: GET /medication-prescription/search-drugs?q=xxx
C -> C: validateSearchQuery(query)
C -> DC: searchDrugs(query, limit, skip)
DC -> DR: searchDrugsByOpenFDA(query, limit, skip)
DR -> DR: mongodb.collection.find()
DR --> DC: drugs\n(drugs matching search query from catalog)
DC -> DC: formatDrugSearchResults(results)
DC --> C: response\n(drugs array with name, NDC, strength, dosage)
C --> F: response\n(search results with drug details)
F --> D: Display drugs list for selection

D -> F: Select drug from list
F -> F: addDrugToItemsList(drug)
F --> D: Display selected drugs list

@enduml