@startuml Medication Prescription Sequence Diagram
!theme plain
title Tương Tác Tạo Đơn Thuốc - Luồng Bác Sĩ

actor "Bác Sĩ" as D
boundary "Giao Diện" as F
control "MedicationPrescriptionController" as C
control "MedicationPrescriptionService" as M
control "DrugCatalogService" as DC
entity "MedicationPrescription" as MP
entity "PatientProfile" as PP
entity "MedicalRecord" as MR
entity "Drug" as DR
database "PostgreSQL" as PG
database "MongoDB" as MG

== Bác sĩ tạo đơn thuốc ==

D -> F: Chọn bệnh nhân và tạo đơn thuốc
F -> C: POST /medication-prescription/create
C -> M: create(createMedicationPrescriptionDto)
M -> M: Kiểm tra items không rỗng

alt Items hợp lệ
  M -> M: Tạo mã đơn thuốc tự động
  M -> MP: Tạo đơn thuốc mới
  MP -> PG: Lưu thông tin đơn thuốc
  PG --> MP: Đơn thuốc đã tạo
  
  M -> MP: Tạo các items thuốc
  MP -> PG: Lưu từng item thuốc
  PG --> MP: Items đã lưu
  MP --> M: Trả về đơn thuốc hoàn chỉnh
  
  M --> C: Trả về đơn thuốc đã tạo
  C --> F: Trả về kết quả tạo đơn thuốc
  F --> D: Hiển thị thông báo tạo thành công
  
else Items rỗng
  M --> C: Trả về lỗi items không hợp lệ
  C --> F: Thông báo lỗi
  F --> D: Hiển thị thông báo lỗi
end

== Tìm kiếm thuốc để thêm vào đơn ==

D -> F: Tìm kiếm thuốc trong catalog
F -> C: GET /medication-prescription/search-drugs?q=xxx
C -> DC: searchDrugs(query, limit, skip)
DC -> DR: Tìm kiếm thuốc theo openfda fields
DR -> MG: Truy vấn MongoDB với điều kiện
MG --> DR: Danh sách thuốc phù hợp
DR --> DC: Trả về kết quả tìm kiếm
DC --> C: Trả về danh sách thuốc
C --> F: Trả về kết quả tìm kiếm
F --> D: Hiển thị danh sách thuốc để chọn

D -> F: Chọn thuốc từ danh sách
F -> F: Thêm thuốc vào danh sách items
F --> D: Hiển thị danh sách thuốc đã chọn

@enduml
