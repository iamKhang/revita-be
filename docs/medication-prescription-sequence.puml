@startuml Medication Prescription Sequence Diagram
!theme plain
title Tương Tác Tạo Đơn Thuốc - Luồng Bác Sĩ

actor "Bác Sĩ" as D
boundary "Giao Diện" as F
control "MedicationPrescriptionController" as C
control "MedicationPrescriptionService" as M
control "DrugCatalogService" as DC
entity "MedicationPrescription" as MP
entity "PatientProfile" as PP
entity "MedicalRecord" as MR
entity "Drug" as DR

== Bác sĩ tạo đơn thuốc ==

D -> F: Chọn bệnh nhân và tạo đơn thuốc
F -> C: POST /medication-prescription/create
C -> C: validateCreateMedicationPrescriptionDto(dto)
C -> M: create(createMedicationPrescriptionDto)
M -> M: validateItemsNotEmpty(items)

alt Items hợp lệ
  M -> M: generatePrescriptionCode()
  M -> MP: createPrescription(prescriptionData)
  MP -> MP: prisma.medicationPrescription.create()
  MP --> M: Đơn thuốc đã tạo
  
  M -> MP: createPrescriptionItems(prescriptionId, items)
  MP -> MP: prisma.medicationPrescriptionItem.createMany()
  MP --> M: Items đã lưu
  MP --> M: Trả về đơn thuốc hoàn chỉnh
  
  M --> C: Trả về đơn thuốc đã tạo
  C --> F: Trả về kết quả tạo đơn thuốc
  F --> D: Hiển thị thông báo tạo thành công
  
else Items rỗng
  M --> C: throw new BadRequestException()
  C --> F: Thông báo lỗi
  F --> D: Hiển thị thông báo lỗi
end

== Tìm kiếm thuốc để thêm vào đơn ==

D -> F: Tìm kiếm thuốc trong catalog
F -> C: GET /medication-prescription/search-drugs?q=xxx
C -> C: validateSearchQuery(query)
C -> DC: searchDrugs(query, limit, skip)
DC -> DR: searchDrugsByOpenFDA(query, limit, skip)
DR -> DR: mongodb.collection.find()
DR --> DC: Trả về kết quả tìm kiếm
DC -> DC: formatDrugSearchResults(results)
DC --> C: Trả về danh sách thuốc
C --> F: Trả về kết quả tìm kiếm
F --> D: Hiển thị danh sách thuốc để chọn

D -> F: Chọn thuốc từ danh sách
F -> F: addDrugToItemsList(drug)
F --> D: Hiển thị danh sách thuốc đã chọn

@enduml
