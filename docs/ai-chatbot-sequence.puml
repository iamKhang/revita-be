@startuml AI Chatbot Sequence Diagram
!theme plain
title AI Chatbot Sequence

actor "User" as U
boundary "Frontend" as F
control "AiChatbotController" as C
control "AiChatbotService" as ACS
control "DatabaseQueryService" as DQS
entity "Gemini AI" as GAI
entity "PrismaService" as PS

== Chat with AI Chatbot ==

U -> F: Send message
F -> C: POST /ai-chatbot/chat
note right: ChatRequestDto
C -> C: JwtAuthGuard.validateToken()
C -> C: validateChatRequest(chatRequest)
C -> ACS: generateResponse(chatRequest)

ACS -> DQS: processDatabaseQuery(message)
DQS -> DQS: isDatabaseRelatedQuestion(message)
alt Database related question
    DQS -> GAI: generatePrismaQuery(question)
    GAI -> GAI: gemini.generateContent()
    GAI --> DQS: queryString\n(Prisma query in string format)
    DQS -> DQS: validateQueryFormat(queryString)
    DQS -> DQS: sanitizeQueryForPatient(queryString)
    DQS -> PS: executePrismaQuery(queryString)
    PS -> PS: prisma.$queryRaw()
    PS --> DQS: queryResults\n(data from database query)
    DQS -> GAI: generateExplanation(question, data)
    GAI -> GAI: gemini.generateContent()
    GAI --> DQS: explanation\n(natural language explanation in Vietnamese)
    DQS --> ACS: response\n(explained data with context)
else Normal medical question
    DQS --> ACS: isDatabaseQuery\n(flag set to false)
    ACS -> GAI: buildMedicalAssistantPrompt(message)
    GAI -> GAI: gemini.generateContent()
    GAI --> ACS: aiResponse\n(medical advice in Vietnamese)
    ACS -> ACS: containsMedicalAdvice(text)
    ACS --> ACS: response\n(general medical response with disclaimer)
end

ACS -> ACS: generateConversationId()
ACS -> ACS: getMedicalDisclaimer()
ACS --> C: response\n(chat response with conversationId, disclaimer, content)
C --> F: response\n(complete AI response)
F --> U: Display AI response

@enduml