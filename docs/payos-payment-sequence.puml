@startuml payosPaymentSequence

actor "Thu ngân" as Cashier
actor "Bệnh nhân" as Patient

boundary "Thu ngân UI" as UI
control "InvoicePaymentController" as Controller
entity "InvoicePaymentService" as Service
entity "PayOsService" as PayOS
entity "RoutingService" as Routing
entity "WebSocketService" as WS

'================= 1. QUÉT PHIẾU CHỈ ĐỊNH =================

Cashier -> UI: Quét mã phiếu chỉ định
UI -> Controller: POST /invoice-payments/scan\nprescriptionCode
Controller -> Service: scanPrescription(dto)
Service -> Service: Tìm prescription + validate
Service --> Controller: PrescriptionDetails\n(services, prices, patient)
Controller --> UI: 200 OK\nthông tin phiếu chỉ định
UI --> Cashier: Hiển thị danh sách dịch vụ\nvà giá

'================= 2. XEM TRƯỚC TỔNG TIỀN =================

loop Chọn dịch vụ & xem tổng tiền
    Cashier -> UI: Tích/bỏ tích dịch vụ
    UI -> Controller: POST /invoice-payments/preview\nprescriptionCode, selectedServiceIds
    Controller -> Service: createPaymentPreview(dto)
  Service -> Service: Lọc selectedServices + tính totalAmount
  Service --> Controller: PaymentPreview\n(selectedServices, totalAmount)
    Controller --> UI: 200 OK preview
    UI --> Cashier: Hiển thị tổng tiền
end

'================= 3. TẠO HÓA ĐƠN PAYOS =================

Cashier -> UI: Chọn TRANSFER và nhấn "Tạo hóa đơn"
UI -> Controller: POST /invoice-payments/create\nprescriptionCode, selectedServiceIds,\npaymentMethod=TRANSFER, returnUrl, cancelUrl
Controller -> Service: createPayment(dto)

Service -> Service: Validate + tạo preview cuối cùng
Service -> Routing: assignPatientToRooms

alt Không có nhân sự phù hợp
  Service --> Controller: Lỗi "không có nhân sự"
    Controller --> UI: 400 Bad Request
  UI --> Cashier: Hiển thị lỗi chưa có nhân sự
else Có nhân sự
  Service -> Service: Tạo invoice + orderCode
  Service -> PayOS: createPaymentLink(orderCode, amount, ... )
  PayOS --> Service: PaymentLinkResult\n(paymentUrl, qrCode, transactionId,...)
  Service -> Service: Lưu paymentTransaction (PENDING)
  Service --> Controller: PaymentResult\n(invoiceCode, totalAmount, paymentUrl, qrCode)
    Controller --> UI: 200 OK payment created
  UI --> Cashier: Hiển thị QR code & hướng dẫn
end

'================= 4. BỆNH NHÂN THANH TOÁN =================

Cashier -> Patient: Hướng dẫn quét QR để thanh toán
Patient -> PayOS: Thanh toán qua app ngân hàng/ví
PayOS -> PayOS: Xử lý thanh toán với ngân hàng

'================= 5. WEBHOOK TỪ PAYOS =================

PayOS -> Controller: POST /invoice-payments/payos/webhook\n(signature, payload)
Controller -> Service: handlePayOsWebhook(payload)

alt Thiếu hoặc sai signature
  Service --> Controller: Bỏ qua / hoặc trả lỗi
  Controller --> PayOS: 200 OK / 400 Bad Request
        else Signature hợp lệ
  Service -> Service: Tìm paymentTransaction\nbằng transactionId / orderCode
  Service -> Service: Map status từ payload\n(SUCCEEDED / FAILED / CANCELLED / PENDING)
  Service -> Service: Cập nhật paymentTransaction

  alt Status = SUCCEEDED
    Service -> Service: Cập nhật invoice.isPaid\nvà prescription.status
    Service -> Routing: assignPatientToRooms (nếu chưa tạo)
    Service ->> WS: notifyInvoicePaymentSuccess\n(kèm routing nếu có)
    WS ->> UI: WebSocket "thanh toán thành công"
    UI --> Cashier: Hiển thị kết quả\nvà cho phép in hóa đơn
  else Status = FAILED hoặc CANCELLED
                Service ->> WS: Notify payment failed
    WS ->> UI: WebSocket "thanh toán thất bại/hủy"
    UI --> Cashier: Hiển thị kết quả\nthanh toán thất bại/hủy
            else Status khác (PENDING/PROCESSING)
    Service -> Service: Chỉ cập nhật trạng thái\ntransaction, không đổi invoice
  end

                Controller --> PayOS: 200 OK
end

@enduml
