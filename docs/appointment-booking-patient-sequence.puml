@startuml Appointment Booking - Patient Sequence Diagram
!theme plain
title Tương Tác Đặt Lịch Khám Bệnh - Luồng Bệnh Nhân

actor "Bệnh Nhân" as P
boundary "Giao Diện" as F
control "Controller" as C
control "Service" as S
entity "Lịch Hẹn" as A
entity "Bác Sĩ" as D
entity "Chuyên Khoa" as SP
entity "Dịch Vụ" as SV
database "Cơ Sở Dữ Liệu" as DB

== Tìm kiếm và chọn bác sĩ ==

P -> F: Tìm kiếm chuyên khoa
F -> C: Lấy danh sách chuyên khoa
C -> S: getSpecialties()
S -> SP: Truy vấn chuyên khoa
SP -> DB: Lấy danh sách chuyên khoa
DB --> SP: Danh sách chuyên khoa
SP --> S: Trả về danh sách chuyên khoa
S --> C: Trả về danh sách chuyên khoa
C --> F: Danh sách chuyên khoa
F --> P: Hiển thị danh sách chuyên khoa

P -> F: Chọn chuyên khoa
F -> C: Lấy danh sách bác sĩ
C -> S: getDoctorsBySpecialty()
S -> D: Truy vấn bác sĩ
D -> DB: Lấy danh sách bác sĩ
DB --> D: Danh sách bác sĩ
D --> S: Trả về danh sách bác sĩ
S --> C: Trả về danh sách bác sĩ
C --> F: Danh sách bác sĩ
F --> P: Hiển thị danh sách bác sĩ

== Đặt lịch khám ==

P -> F: Chọn bác sĩ và ngày
F -> C: Lấy lịch làm việc
C -> S: getDoctorWorkingDays()
S -> D: Truy vấn work sessions
D -> DB: Lấy lịch làm việc
DB --> D: Lịch làm việc
D --> S: Trả về lịch làm việc
S --> C: Trả về lịch làm việc
C --> F: Lịch làm việc
F --> P: Hiển thị lịch làm việc

P -> F: Chọn dịch vụ và khung giờ
F -> C: Lấy lịch trống
C -> S: getAvailableSlots()
S -> A: Tính toán slots trống

note over S: Tính toán slots trống:\n- Duyệt work sessions\n- Tạo slots theo thời lượng\n- Kiểm tra xung đột

A -> DB: Lấy dữ liệu work sessions
DB --> A: Dữ liệu work sessions
A --> S: Trả về danh sách lịch trống
S --> C: Trả về danh sách lịch trống
C --> F: Danh sách lịch trống
F --> P: Hiển thị khung giờ khả dụng

P -> F: Nhập thông tin và đặt lịch
F -> C: Đặt lịch khám bệnh
C -> S: bookAppointment()

S -> A: Kiểm tra xung đột
A -> DB: Kiểm tra xung đột
DB --> A: Kết quả kiểm tra

alt Không có xung đột
  S -> A: Tạo lịch hẹn mới
  A -> DB: Lưu lịch hẹn
  DB --> A: Lịch hẹn đã tạo
  
  A --> S: Trả về lịch hẹn mới
  S --> C: Trả về thông tin lịch hẹn
  C --> F: Thông tin lịch hẹn đã tạo
  F --> P: Gửi mã lịch hẹn và thông báo thành công
  
else Có xung đột
  S --> C: Trả về lỗi xung đột
  C --> F: Thông báo lỗi
  F --> P: Thông báo lịch đã được đặt, chọn khung giờ khác
end

@enduml
