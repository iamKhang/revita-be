@startuml Appointment Booking - Patient Sequence Diagram
!theme plain
title Tương Tác Đặt Lịch Khám Bệnh - Luồng Bệnh Nhân

actor "Bệnh Nhân" as P
boundary "Giao Diện" as F
control "AppointmentBookingController" as C
control "AppointmentBookingService" as S
entity "Lịch Hẹn" as A
entity "Bác Sĩ" as D
entity "Chuyên Khoa" as SP
entity "Dịch Vụ" as SV

== Tìm kiếm và chọn bác sĩ ==

P -> F: Tìm kiếm chuyên khoa
F -> C: GET /appointment-booking/specialties
C -> C: validateRequest()
C -> S: getSpecialties()
S -> SP: findAllSpecialties()
SP -> SP: prisma.specialty.findMany()
SP --> S: Trả về danh sách chuyên khoa
S --> C: Trả về danh sách chuyên khoa
C --> F: Danh sách chuyên khoa
F --> P: Hiển thị danh sách chuyên khoa

P -> F: Chọn chuyên khoa
F -> C: GET /appointment-booking/doctors?specialtyId=xxx
C -> C: validateSpecialtyId(specialtyId)
C -> S: getDoctorsBySpecialty(specialtyId)
S -> D: findDoctorsBySpecialty(specialtyId)
D -> D: prisma.doctor.findMany()
D --> S: Trả về danh sách bác sĩ
S --> C: Trả về danh sách bác sĩ
C --> F: Danh sách bác sĩ
F --> P: Hiển thị danh sách bác sĩ

== Đặt lịch khám ==

P -> F: Chọn bác sĩ và ngày
F -> C: GET /appointment-booking/working-days?doctorId=xxx
C -> C: validateDoctorId(doctorId)
C -> S: getDoctorWorkingDays(doctorId)
S -> D: getWorkSessionsByDoctor(doctorId)
D -> D: prisma.workSession.findMany()
D --> S: Trả về lịch làm việc
S --> C: Trả về lịch làm việc
C --> F: Lịch làm việc
F --> P: Hiển thị lịch làm việc

P -> F: Chọn dịch vụ và khung giờ
F -> C: GET /appointment-booking/available-slots
C -> C: validateAvailableSlotsDto(dto)
C -> S: getAvailableSlots(dto)
S -> A: calculateAvailableSlots(workSessions, serviceDuration)

note over S: Tính toán slots trống:\n- Duyệt work sessions\n- Tạo slots theo thời lượng\n- Kiểm tra xung đột

A -> A: generateTimeSlots(workSessions)
A -> A: filterAvailableSlots(slots, existingAppointments)
A --> S: Trả về danh sách lịch trống
S --> C: Trả về danh sách lịch trống
C --> F: Danh sách lịch trống
F --> P: Hiển thị khung giờ khả dụng

P -> F: Nhập thông tin và đặt lịch
F -> C: POST /appointment-booking/book
C -> C: validateBookAppointmentDto(dto)
C -> S: bookAppointment(bookAppointmentDto, user)

S -> A: checkSlotConflict(appointmentData)
A -> A: prisma.appointment.findFirst()

alt Không có xung đột
  S -> A: createAppointment(appointmentData)
  A -> A: prisma.appointment.create()
  A --> S: Trả về lịch hẹn mới
  S --> C: Trả về thông tin lịch hẹn
  C --> F: Thông tin lịch hẹn đã tạo
  F --> P: Gửi mã lịch hẹn và thông báo thành công
  
else Có xung đột
  S --> C: throw new ConflictException()
  C --> F: Thông báo lỗi
  F --> P: Thông báo lịch đã được đặt, chọn khung giờ khác
end

@enduml
