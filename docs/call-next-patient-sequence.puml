@startuml callNextPatientSequence

actor "Counter Staff" as Staff
actor "Waiting Patient" as Patient

boundary "Counter Screen" as CounterUI
boundary "Waiting Room Screen" as WaitingUI

control "CounterAssignmentController" as Controller
control "CounterAssignmentService" as Service
control "WebSocketService" as WS

Staff -> CounterUI: Press call next patient button
activate CounterUI

CounterUI -> Controller: POST /counter-assignment/next-patient/:counterId
activate Controller

Controller -> Service: callNextPatient(counterId)
activate Service

Service -> Service: getCurrentQueue(counterId)

Service -> Service: getCurrentPatient(counterId)

alt Has patient currently SERVING
    Service -> Service: setCurrentPatient(counterId, null)
    
    Service -> WS: notifyTicketCompleted(counterId, patient)
    activate WS
    WS -> CounterUI: Notify patient completed
    WS -> WaitingUI: Update completed status
    deactivate WS
    
    Service -> Service: publishPatientServed(counterId, patient)
end

Service -> Service: getQueueStatusWithCleanup(counterId)

alt Queue is empty
    Service -> Service: checkAndResetSequenceIfEmpty(counterId)
    
    Service --> Controller: No patients in queue
    deactivate Service
    Controller --> CounterUI: No patients available
    deactivate Controller
    CounterUI --> Staff: Display No patients waiting
    deactivate CounterUI
else Queue has patients
    Service -> Service: Get patient with highest priority
    
    Service -> Service: Create preparingPatient\nstatus = PREPARING\nisPriority = true
    
    Service -> Service: removeTicketFromQueue(counterId, nextPatientId)
    
    Service -> Service: addTicketToQueue(counterId, preparingPatient,\nMAX_SAFE_INTEGER priority)
    
    Service -> WS: sendToCounter(counterId, preparingPatient)
    activate WS
    WS -> CounterUI: Notify preparing
    deactivate WS
    
    Service -> Service: publishPatientPreparing(counterId, patient)
    
    Service -> Service: callNextPatientOptimized(counterId)
    
    Service -> Service: getCurrentPatient(counterId)
    
    alt previousCurrent != updatedCurrent
        Service -> Service: savePreviousCurrent(previousCurrent)
    end
    
    Service -> Service: Normalize current\nstatus = SERVING
    
    Service -> Service: setCurrentPatient(counterId, currentPatient)
    
    Service -> Service: updateNextPatientInQueue(counterId)\nSelect next patient with highest priority
    
    Service -> Service: getCurrentQueue(counterId)
    
    Service -> Service: Find patient with highest priority\nMark status = NEXT
    
    Service -> Service: updatePatientStatus(nextPatientId, NEXT)
    
    Service -> Service: publishNextPatientCalled(counterId, patient)
    
    Service -> Service: getCurrentQueue(counterId)
    
    Service -> Service: compareQueueAndNotify(oldQueue, newQueue)
    
    Service -> WS: notifyQueuePositionChanges(counterId, changes)
    activate WS
    WS -> CounterUI: Update Current, Next, Moved
    WS -> WaitingUI: Update new waiting list
    deactivate WS
    
    Service -> Service: mapTicketForFrontend(ticket)
    
    Service --> Controller: Response ok patient data
    deactivate Service
    
    Controller -> Service: getQueueStatus(counterId)
    activate Service
    Service -> Service: getCurrentQueue(counterId)
    Service --> Controller: queueStatus
    deactivate Service
    
    Controller -> Service: getCurrentPatient(counterId)
    activate Service
    Service -> Service: getCurrentPatient(counterId)
    Service --> Controller: currentPatient
    deactivate Service
    
    Controller --> CounterUI: Response with patient data
    deactivate Controller
    
    CounterUI --> Staff: Display serving patient\nand waiting list
    deactivate CounterUI
    
    WaitingUI --> Patient: Display called queue number\nand waiting position
end

@enduml
