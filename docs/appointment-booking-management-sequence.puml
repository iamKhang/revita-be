@startuml Appointment Booking - Management Sequence Diagram
!theme plain

actor "Doctor" as D
boundary "Frontend" as F
control "WorkSessionController" as C
control "WorkSessionService" as S
entity "WorkSession" as WS
entity "Doctor" as DOC
entity "Service" as SV

D -> F: Request to create work session
F -> C: POST /work-session/create
note right: CreateWorkSessionDto
C -> C: validateCreateWorkSessionDto(dto)
C -> S: createWorkSession(createWorkSessionDto, user)
S -> WS: validateWorkSessionData(data)
WS -> WS: checkDuplicateSchedule(data)
WS -> WS: prisma.workSession.findFirst()

alt No conflict
  WS -> WS: prisma.workSession.create()
  WS --> S: workSession\n(id, boothId, doctorId, startTime, endTime, status, services)
  S --> C: workSessionData\n(id, boothName, doctorInfo, timeRange, status)
  C --> F: response\n(work session details with confirmation)
  F --> D: Display success message
  
else Conflict detected
  WS --> S: throw ConflictException()
  S --> C: error\n(conflict message and details)
  C --> F: error\n(HTTP error response)
  F --> D: Display conflict message
end

D -> F: Request work sessions
F -> C: GET /work-session/doctor
C -> C: validateRequest()
C -> S: getDoctorWorkSessions(user)
S -> WS: findByDoctorId(user.id)
WS -> WS: prisma.workSession.findMany()
WS --> S: workSessions\n(all work session records for doctor)
S --> C: workSessions\n(formatted list with booth, services info)
C --> F: workSessions\n(work sessions array)
F --> D: Display work sessions list

D -> F: Request to update work session
F -> C: PUT /work-session/update/:id
C -> C: validateId(id)
C -> C: validateUpdateWorkSessionDto(dto)
C -> S: updateWorkSession(id, updateWorkSessionDto, user)
S -> WS: checkWorkSessionExists(id)
WS -> WS: prisma.workSession.findUnique()
WS -> WS: checkHasAppointments(id)
WS -> WS: prisma.appointment.findFirst()

alt No appointments
  WS -> WS: prisma.workSession.update()
  WS --> S: workSession\n(updated work session record)
  S --> C: workSessionData\n(updated work session details)
  C --> F: response\n(work session with new time/services)
  F --> D: Display update success message
  
else Has appointments
  WS --> S: throw BadRequestException()
  S --> C: error\n(not allowed to modify message)
  C --> F: error\n(HTTP error response)
  F --> D: Display cannot modify message
end

D -> F: Request to cancel work session
F -> C: DELETE /work-session/cancel/:id
C -> C: validateId(id)
C -> S: cancelWorkSession(id, user)
S -> WS: checkWorkSessionExists(id)
WS -> WS: prisma.workSession.findUnique()
WS -> WS: checkHasAppointments(id)
WS -> WS: prisma.appointment.findFirst()

alt No appointments
  WS -> WS: prisma.workSession.update({status: 'cancelled'})
  WS --> S: workSession\n(cancelled work session record)
  S --> C: response\n(cancelled work session confirmation)
  C --> F: response\n(work session marked as cancelled)
  F --> D: Display cancel success message
  
else Has appointments
  WS --> S: throw BadRequestException()
  S --> C: error\n(not allowed to cancel message)
  C --> F: error\n(HTTP error response)
  F --> D: Display cannot cancel message
end

@enduml