@startuml Appointment Booking - Management Sequence Diagram
!theme plain
title Tương Tác Đăng Lịch Khám Bệnh - Luồng Bác Sĩ

actor "Bác Sĩ" as D
boundary "Giao Diện" as F
control "WorkSessionController" as C
control "WorkSessionService" as S
entity "Lịch Làm Việc" as WS
entity "Bác Sĩ" as DOC
entity "Dịch Vụ" as SV

== Đăng lịch làm việc mới ==

D -> F: Đăng lịch làm việc mới
F -> C: POST /work-session/create
C -> C: validateCreateWorkSessionDto(dto)
C -> S: createWorkSession(createWorkSessionDto, user)
S -> WS: validateWorkSessionData(data)
WS -> WS: checkDuplicateSchedule(data)
WS -> WS: prisma.workSession.findFirst()

alt Không có trùng lặp
  WS -> WS: prisma.workSession.create()
  WS --> S: Trả về work session mới
  S --> C: Trả về thông tin lịch làm việc
  C --> F: Trả về kết quả đăng lịch
  F --> D: Thông báo đăng lịch thành công
  
else Có trùng lặp
  WS --> S: throw new ConflictException()
  S --> C: Trả về lỗi
  C --> F: Thông báo lỗi
  F --> D: Thông báo lịch trùng lặp, chỉnh sửa thời gian
end

== Xem lịch làm việc đã đăng ==

D -> F: Xem lịch làm việc đã đăng
F -> C: GET /work-session/doctor
C -> C: validateRequest()
C -> S: getDoctorWorkSessions(user)
S -> WS: findByDoctorId(user.id)
WS -> WS: prisma.workSession.findMany()
WS --> S: Trả về danh sách lịch làm việc
S --> C: Trả về danh sách lịch làm việc
C --> F: Danh sách lịch làm việc
F --> D: Hiển thị lịch làm việc đã đăng

== Cập nhật lịch làm việc ==

D -> F: Cập nhật lịch làm việc
F -> C: PUT /work-session/update/:id
C -> C: validateId(id)
C -> C: validateUpdateWorkSessionDto(dto)
C -> S: updateWorkSession(id, updateWorkSessionDto, user)
S -> WS: checkWorkSessionExists(id)
WS -> WS: prisma.workSession.findUnique()
WS -> WS: checkHasAppointments(id)
WS -> WS: prisma.appointment.findFirst()

alt Chưa có bệnh nhân đặt
  WS -> WS: prisma.workSession.update()
  WS --> S: Trả về work session đã cập nhật
  S --> C: Trả về thông tin lịch làm việc
  C --> F: Thông tin lịch làm việc đã cập nhật
  F --> D: Thông báo cập nhật thành công
  
else Đã có bệnh nhân đặt
  WS --> S: throw new BadRequestException()
  S --> C: Trả về lỗi
  C --> F: Thông báo lỗi
  F --> D: Thông báo không thể chỉnh sửa, liên hệ bệnh nhân
end

== Hủy lịch làm việc ==

D -> F: Hủy lịch làm việc
F -> C: DELETE /work-session/cancel/:id
C -> C: validateId(id)
C -> S: cancelWorkSession(id, user)
S -> WS: checkWorkSessionExists(id)
WS -> WS: prisma.workSession.findUnique()
WS -> WS: checkHasAppointments(id)
WS -> WS: prisma.appointment.findFirst()

alt Chưa có bệnh nhân đặt
  WS -> WS: prisma.workSession.update({status: 'cancelled'})
  WS --> S: Trả về work session đã hủy
  S --> C: Trả về kết quả hủy lịch
  C --> F: Kết quả hủy lịch làm việc
  F --> D: Thông báo hủy lịch thành công
  
else Đã có bệnh nhân đặt
  WS --> S: throw new BadRequestException()
  S --> C: Trả về lỗi
  C --> F: Thông báo lỗi
  F --> D: Thông báo không thể hủy, liên hệ bệnh nhân trước
end

@enduml