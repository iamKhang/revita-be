@startuml createPackageSequence

actor "Quản lý" as Admin

boundary "Admin UI" as UI
control "ServiceController" as Controller
entity "ServiceService" as Service
entity "PrismaService" as Prisma
database "PostgreSQL" as DB

== Tạo gói dịch vụ ==

Admin -> UI: Chọn Thêm gói dịch vụ
activate UI

UI --> Admin: Hiển thị form\nthêm gói dịch vụ
deactivate UI

Admin -> UI: Điền thông tin cơ bản:\nname, price,\ndescription,\ncategoryId, specialtyId,\nrequiresDoctor, isActive
activate UI

loop Thêm dịch vụ vào gói
    Admin -> UI: Nhấn Thêm dịch vụ

    UI --> Admin: Hiển thị danh sách\ndịch vụ có sẵn

    Admin -> UI: Chọn dịch vụ\nvà điền thông tin:\nquantity, priceOverride,\nrequired, sortOrder, notes

    UI -> UI: Thêm vào danh sách items
end

UI -> UI: Validate form\nname và price bắt buộc

alt Validation thất bại
    UI --> Admin: Hiển thị lỗi\nthiếu thông tin bắt buộc
    deactivate UI
else Validation thành công
    Admin -> UI: Nhấn Tạo gói dịch vụ

    UI -> Controller: POST /services/management/packages\nCreatePackageDto\nwith items array
    activate Controller

    Controller -> Service: createPackage(dto)
    activate Service

    alt Có categoryId
        Service -> Prisma: findUnique category
        activate Prisma
        Prisma -> DB: SELECT category\nWHERE id
        activate DB
        DB --> Prisma: Category or null
        deactivate DB
        Prisma --> Service: Category or null
        deactivate Prisma

        alt Category không tồn tại
            Service --> Controller: Error category not found
            Controller --> UI: 400 Bad Request
            UI --> Admin: Hiển thị lỗi\ncategory không tồn tại
            deactivate UI
            deactivate Controller
            deactivate Service
        end
    end

    alt Có specialtyId
        Service -> Prisma: findUnique specialty
        activate Prisma
        Prisma -> DB: SELECT specialty\nWHERE id
        activate DB
        DB --> Prisma: Specialty or null
        deactivate DB
        Prisma --> Service: Specialty or null
        deactivate Prisma

        alt Specialty không tồn tại
            Service --> Controller: Error specialty not found
            Controller --> UI: 400 Bad Request
            UI --> Admin: Hiển thị lỗi\nspecialty không tồn tại
            deactivate UI
            deactivate Controller
            deactivate Service
        end
    end

    Service -> Service: Check duplicate\nserviceIds in items

    alt Có serviceId trùng lặp
        Service --> Controller: Error duplicate services
        Controller --> UI: 400 Bad Request
        UI --> Admin: Hiển thị lỗi\ndịch vụ trùng lặp trong gói
        deactivate UI
        deactivate Controller
        deactivate Service
    end

    Service -> Prisma: findMany services\nWHERE id IN serviceIds
    activate Prisma

    Prisma -> DB: SELECT service\nWHERE id IN list
    activate DB
    DB --> Prisma: Services found
    deactivate DB

    Prisma --> Service: Services array
    deactivate Prisma

    Service -> Service: Validate all serviceIds exist

    alt Có serviceId không tồn tại
        Service --> Controller: Error service not found
        Controller --> UI: 400 Bad Request
        UI --> Admin: Hiển thị lỗi\ndịch vụ không tồn tại
        deactivate UI
        deactivate Controller
        deactivate Service
    end

    Service -> Service: generateUniquePackageCode

    Service -> Prisma: Begin transaction
    activate Prisma

    Prisma -> DB: BEGIN TRANSACTION
    activate DB
    DB --> Prisma: Transaction started
    deactivate DB

    Prisma -> DB: INSERT INTO package\ncode, name, price,\ndescription, isActive,\nrequiresDoctor,\ncategoryId, specialtyId
    activate DB
    DB --> Prisma: Package created
    deactivate DB

    alt Có items
        Prisma -> DB: INSERT INTO packageItem\nbulk insert\npackageId, serviceId,\nquantity, priceOverride,\nrequired, sortOrder, notes\nfor each item
        activate DB

        alt Insert items thất bại
            DB --> Prisma: Error constraint violation
            deactivate DB

            Prisma -> DB: ROLLBACK TRANSACTION
            activate DB
            DB --> Prisma: Transaction rolled back
            deactivate DB

            Prisma --> Service: Error
            deactivate Prisma

            Service --> Controller: Error cannot create package
            deactivate Service

            Controller --> UI: 500 Internal Server Error
            deactivate Controller

            UI --> Admin: Hiển thị lỗi\nkhông thể tạo gói dịch vụ
            deactivate UI
        else Insert items thành công
            DB --> Prisma: PackageItems created
            deactivate DB

            Prisma -> DB: COMMIT TRANSACTION
            activate DB
            DB --> Prisma: Transaction committed
            deactivate DB

            Prisma --> Service: Package created
            deactivate Prisma

            Service -> Prisma: getPackageManagementById
            activate Prisma

            Prisma -> DB: SELECT package\nWHERE id\nINCLUDE category, specialty,\nitems with services
            activate DB
            DB --> Prisma: Package with relations
            deactivate DB

            Prisma --> Service: Package details
            deactivate Prisma

            Service --> Controller: Package created
            deactivate Service

            Controller --> UI: 200 OK\npackage data
            deactivate Controller

            UI --> Admin: Hiển thị thông báo\ntạo gói dịch vụ thành công\nvà thông tin gói mới\nvới danh sách dịch vụ
            deactivate UI
        end
    else Không có items
        Prisma -> DB: COMMIT TRANSACTION
        activate DB
        DB --> Prisma: Transaction committed
        deactivate DB

        Prisma --> Service: Package created
        deactivate Prisma

        Service -> Prisma: getPackageManagementById
        activate Prisma

        Prisma -> DB: SELECT package\nWHERE id\nINCLUDE category, specialty
        activate DB
        DB --> Prisma: Package with relations
        deactivate DB

        Prisma --> Service: Package details
        deactivate Prisma

        Service --> Controller: Package created
        deactivate Service

        Controller --> UI: 200 OK\npackage data
        deactivate Controller

        UI --> Admin: Hiển thị thông báo\ntạo gói dịch vụ thành công\nvà thông tin gói mới
        deactivate UI
    end
end

@enduml

