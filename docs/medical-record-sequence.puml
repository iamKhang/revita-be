@startuml Medical Record Sequence Diagram
!theme plain
title Tương Tác Tạo và Quản Lý Bệnh Án - Luồng Bác Sĩ

actor "Bác Sĩ" as D
boundary "Giao Diện" as F
control "MedicalRecordController" as C
control "MedicalRecordService" as M
entity "MedicalRecord" as MR
entity "PatientProfile" as PP
entity "Template" as T
entity "MedicalRecordHistory" as MRH

== Tạo bệnh án mới ==

D -> F: Chọn bệnh nhân
F -> C: GET /medical-record/templates
C -> C: validateRequest()
C -> M: getTemplates()
M -> T: findAllTemplates()
T -> T: prisma.template.findMany()
T --> M: Trả về danh sách template
M --> C: Trả về danh sách template
C --> F: Danh sách template
F --> D: Hiển thị danh sách template

D -> F: Chọn template và gửi yêu cầu tạo bệnh án
F -> C: POST /medical-record/create
C -> C: validateCreateMedicalRecordDto(dto)
C -> M: create(createMedicalRecordDto, user)
M -> M: checkCreatePermission(user)

alt Có quyền tạo
  M -> M: extractDoctorId(user)
  M -> PP: validatePatientProfile(patientProfileId)
  PP -> PP: prisma.patientProfile.findUnique()
  PP --> M: Xác nhận patient profile hợp lệ
  
  M -> M: generateMedicalRecordCode()
  M -> MR: createMedicalRecord(data)
  MR -> MR: prisma.medicalRecord.create()
  MR --> M: Trả về bệnh án mới
  
  M -> MRH: createHistoryRecord(medicalRecordId, action)
  MRH -> MRH: prisma.medicalRecordHistory.create()
  MRH --> M: Xác nhận lưu history
  
  M --> C: Trả về bệnh án đã tạo
  C --> F: Trả về kết quả tạo bệnh án
  F --> D: Hiển thị thông báo tạo thành công
  
else Không có quyền
  M --> C: throw new ForbiddenException()
  C --> F: Thông báo lỗi
  F --> D: Hiển thị thông báo không có quyền
end

== Xem và quản lý bệnh án ==

D -> F: Xem danh sách bệnh án
F -> C: GET /medical-record?page=1&limit=10
C -> C: validatePaginationParams(page, limit)
C -> M: findAll(user, page, limit)
M -> M: checkDoctorRole(user)
M -> MR: findByDoctorId(user.id, page, limit)
MR -> MR: prisma.medicalRecord.findMany()
MR --> M: Trả về danh sách bệnh án
M -> M: formatPaginationResponse(data, page, limit)
M --> C: Trả về danh sách với phân trang
C --> F: Trả về kết quả
F --> D: Hiển thị danh sách bệnh án

D -> F: Chọn bệnh án để xem chi tiết
F -> C: GET /medical-record/:id
C -> C: validateId(id)
C -> M: findOne(id, user)
M -> MR: findById(id)
MR -> MR: prisma.medicalRecord.findUnique()
MR --> M: Trả về bệnh án
M -> M: checkViewPermission(medicalRecord, user)
M --> C: Trả về chi tiết bệnh án
C --> F: Trả về thông tin bệnh án
F --> D: Hiển thị chi tiết bệnh án


@enduml
