// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Định nghĩa enum cho các vai trò
enum Role {
  DOCTOR
  PATIENT
  RECEPTIONIST
  ADMIN
  CASHIER
  TECHNICIAN
}

// Bảng Auth cho thông tin đăng nhập và thông tin cơ bản
model Auth {
  id           String        @id @default(uuid())
  phone        String?       @unique
  email        String?       @unique
  googleId     String?       @unique @map("google_id") // Lưu ID từ Google
  password     String?
  accessToken  String?       @map("access_token") // Lưu access token từ Google 
  refreshToken String?       @map("refresh_token") // Lưu refresh token để làm mới access token
  tokenExpiry  DateTime?     @map("token_expiry") // Thời gian hết hạn của access token
  // Thông tin cơ bản từ User
  name         String
  dateOfBirth  DateTime      @map("date_of_birth")
  gender       String
  avatar       String?
  address      String
  citizenId    String?       @unique @map("citizen_id") // Số CMND/CCCD - có thể null
  role         Role
  // Quan hệ với các bảng chuyên biệt
  doctor       Doctor?
  patient      Patient?
  receptionist Receptionist?
  admin        Admin?
  cashier      Cashier?
  technician   Technician?

  comments     Comment[]
  likes        PostLike[]
  commentLikes CommentLike[]

  @@map("auths")
}

// Bảng Technician cho kỹ thuật viên
model Technician {
  id                   String                @id @default(uuid())
  technicianCode       String                @unique @map("technician_code")
  authId               String                @unique @map("auth_id")
  auth                 Auth                  @relation(fields: [authId], references: [id])
  workSessions         WorkSession[]
  prescriptionServices PrescriptionService[]
  certificates         Certificate[]
  isActive             Boolean               @default(true) @map("is_active") // Còn đang làm việc hay đã nghỉ

  @@map("technicians")
}

// Bảng Doctor cho thông tin bác sĩ
model Doctor {
  id              String    @id @default(uuid())
  doctorCode      String    @unique @map("doctor_code")
  authId          String    @unique @map("auth_id")
  yearsExperience Int       @map("years_experience")
  rating          Float     @default(0) @map("rating") // Rating trung bình từ các đánh giá
  ratingCount     Int       @default(0) @map("rating_count") // Số lượng đánh giá
  workHistory     String    @map("work_history")
  description     String    @map("description")
  specialtyId     String    @map("specialty_id") // Chuyên khoa chính
  specialty       Specialty @relation(fields: [specialtyId], references: [id])
  subSpecialties  String[]  @default([]) @map("sub_specialties")
  position        String?   @map("position") // Chức vụ (Trưởng khoa, Bác sĩ nội trú, ...)
  isActive        Boolean   @default(true) @map("is_active") // Còn đang làm việc hay đã nghỉ

  auth                    Auth                     @relation(fields: [authId], references: [id])
  appointments            Appointment[]
  medicalRecords          MedicalRecord[]
  prescriptions           Prescription[]
  workSessions            WorkSession[]
  prescriptionServices    PrescriptionService[]
  medicationPrescriptions MedicationPrescription[]
  certificates            Certificate[]
  ratings                 DoctorRating[] // Quan hệ với các đánh giá

  @@map("doctors")
}

// Bảng Patient cho thông tin bệnh nhân (người đăng ký)
model Patient {
  id              String           @id @default(uuid())
  patientCode     String           @map("patient_code")
  authId          String?          @unique @map("auth_id")
  auth            Auth?            @relation(fields: [authId], references: [id])
  loyaltyPoints   Int              @default(0) @map("loyalty_points") // Điểm thưởng
  patientProfiles PatientProfile[] // Quan hệ với các hồ sơ khám bệnh (có thể null)
  doctorRatings   DoctorRating[] // Quan hệ với các đánh giá bác sĩ

  @@map("patients")
}

// Bảng PatientProfile cho hồ sơ khám bệnh của từng người (độc lập)
model PatientProfile {
  id                      String                   @id @default(uuid())
  profileCode             String                   @map("profile_code")
  patientId               String?                  @map("patient_id") // Có thể null - không bắt buộc phải có Patient
  name                    String // Tên người khám
  phone                   String? // Số điện thoại của người khám (có thể trùng)
  dateOfBirth             DateTime                 @map("date_of_birth")
  gender                  String
  address                 String?
  occupation              String?                  @map("occupation") // Nghề nghiệp
  emergencyContact        Json                     @map("emergency_contact") // Liên hệ khẩn cấp
  healthInsurance         String?                  @map("health_insurance") // Bảo hiểm y tế
  relationship            String? // Mối quan hệ với người đăng ký (ba, mẹ, con, vợ, chồng, ...)
  isActive                Boolean                  @default(true) @map("is_active")
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  isPregnant              Boolean                  @default(false) @map("is_pregnant")
  isDisabled              Boolean                  @default(false) @map("is_disabled")
  patient                 Patient?                 @relation(fields: [patientId], references: [id]) // Quan hệ optional
  appointments            Appointment[]
  medicalRecords          MedicalRecord[]
  prescriptions           Prescription[]
  invoices                Invoice[]
  medicationPrescriptions MedicationPrescription[]

  @@map("patient_profiles")
}

// Bảng Receptionist cho lễ tân/phụ tá
model Receptionist {
  id                 String              @id @default(uuid())
  receptionistCode   String              @unique @map("receptionist_code")
  authId             String              @unique @map("auth_id")
  auth               Auth                @relation(fields: [authId], references: [id])
  counters           Counter[] // Quan hệ với các counter
  counterAssignments CounterAssignment[] // Quan hệ với counter assignments
  isActive           Boolean             @default(true) @map("is_active") // Còn đang làm việc hay đã nghỉ
  // No certificates for receptionist

  @@map("receptionists")
}

// Bảng Counter cho quầy khám
model Counter {
  id          String   @id @default(uuid())
  counterCode String   @unique @map("counter_code") // Mã quầy: CTR001, CTR002,...
  counterName String   @map("counter_name") // Tên quầy: Quầy 1, Quầy 2,...
  location    String?  @map("location") // Vị trí: Tầng 1, Tầng 2,...
  isActive    Boolean  @default(true) @map("is_active")
  maxQueue    Int      @default(10) @map("max_queue") // Số lượng tối đa trong queue
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  receptionistId String?       @map("receptionist_id") // Có thể null khi không có receptionist
  receptionist   Receptionist? @relation(fields: [receptionistId], references: [id])

  // Quan hệ với assignments
  assignments CounterAssignment[]

  @@map("counters")
}

// Bảng CounterAssignment để lưu lịch sử phân bổ Receptionist vào Counter
model CounterAssignment {
  id             String    @id @default(uuid())
  counterId      String    @map("counter_id")
  receptionistId String    @map("receptionist_id")
  assignedAt     DateTime  @default(now()) @map("assigned_at")
  completedAt    DateTime? @map("completed_at")
  status         String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  isVip          Boolean?  @map("is_vip")
  notes          String?   @map("notes")

  counter      Counter      @relation(fields: [counterId], references: [id])
  receptionist Receptionist @relation(fields: [receptionistId], references: [id])

  @@map("counter_assignments")
}

// Bảng Admin cho admin phòng khám
model Admin {
  id         String         @id @default(uuid())
  adminCode  String         @map("admin_code")
  authId     String         @unique @map("auth_id")
  auth       Auth           @relation(fields: [authId], references: [id])
  posts      Post[]
  categories PostCategory[]
  series     Series[]
  isActive   Boolean        @default(true) @map("is_active") // Còn đang làm việc hay đã nghỉ
  position   String?        @map("position") // Chức vụ (Trưởng phòng, Trưởng khoa, ...)
  // No certificates for admin

  @@map("admins")
}

// Nhân viên thu ngân
model Cashier {
  id          String  @id @default(uuid())
  cashierCode String  @unique @map("cashier_code")
  authId      String  @unique @map("auth_id")
  auth        Auth    @relation(fields: [authId], references: [id])
  isActive    Boolean @default(true) @map("is_active") // Còn đang làm việc hay đã nghỉ
  // No certificates for cashier

  invoices Invoice[]

  @@map("cashiers")
}

// Bảng Specialty cho chuyên khoa
model Specialty {
  id            String        @id @default(uuid()) @map("id")
  specialtyCode String        @unique @map("specialty_code")
  name          String
  imgUrl        String?       @map("img_url")
  description   String?       @map("description")
  clinicRooms   ClinicRoom[]
  appointments  Appointment[]
  templates     Template[]
  services      Service[]
  packages      Package[]
  doctors       Doctor[]

  @@map("specialties")
}

// Bảng ClinicRoom cho phòng khám
model ClinicRoom {
  id          String   @id @default(uuid())
  roomCode    String   @unique @map("room_code") // Mã phòng
  roomName    String   @map("room_name") // Tên phòng
  specialtyId String   @map("specialty_id")
  description String?  @map("description") // Mô tả phòng
  address     String?  @map("address") // Địa chỉ phòng
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  booth       Booth[]

  specialty            Specialty             @relation(fields: [specialtyId], references: [id])
  services             ClinicRoomService[]
  prescriptionServices PrescriptionService[]

  @@map("clinic_rooms")
}

// Bảng trung gian ClinicRoomService cho quan hệ nhiều-nhiều giữa phòng khám và dịch vụ
model ClinicRoomService {
  clinicRoomId String     @map("clinic_room_id")
  serviceId    String     @map("service_id")
  clinicRoom   ClinicRoom @relation(fields: [clinicRoomId], references: [id])
  service      Service    @relation(fields: [serviceId], references: [id])

  @@unique([clinicRoomId, serviceId])
  @@map("clinic_room_services")
}

model BoothService {
  boothId   String
  serviceId String
  booth     Booth   @relation(fields: [boothId], references: [id])
  service   Service @relation(fields: [serviceId], references: [id])
  isActive  Boolean @default(true) @map("is_active")

  @@unique([boothId, serviceId])
  @@map("booth_services")
}

// Dịch vụ nguyên tử (bán lẻ được)
model Service {
  id              String           @id @default(uuid())
  serviceCode     String           @unique @map("service_code")
  name            String           @map("name")
  price           Float?           @map("price")
  description     String?          @map("description")
  durationMinutes Int?             @default(15) @map("duration_minutes") @db.SmallInt
  isActive        Boolean          @default(true) @map("is_active")
  unit            String?          @map("unit")
  currency        String?          @default("VND") @map("currency")
  categoryId      String?          @map("category_id")
  category        ServiceCategory? @relation(fields: [categoryId], references: [id])
  specialtyId     String?          @map("specialty_id")
  specialty       Specialty?       @relation(fields: [specialtyId], references: [id])
  requiresDoctor  Boolean          @default(false) @map("requires_doctor")

  // Liên kết tới các gói
  packageItems PackageItem[]

  // Quan hệ khác của hệ thống (giữ nguyên)
  clinicRoomServices  ClinicRoomService[]
  prescriptions       PrescriptionService[]
  invoiceDetails      InvoiceDetail[]
  promotion           ServicePromotion?
  workSessionServices WorkSessionService[]
  appointmentServices AppointmentService[]
  appointments        Appointment[]
  boothServices       BoothService[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("services")
}

model ServicePromotion {
  id                   String  @id @default(uuid())
  serviceId            String  @unique @map("service_id")
  service              Service @relation(fields: [serviceId], references: [id])
  name                 String? @map("name")
  description          String? @map("description")
  allowLoyaltyDiscount Boolean @default(true) @map("allow_loyalty_discount")
  maxDiscountPercent   Float?  @map("max_discount_percent")
  maxDiscountAmount    Float?  @map("max_discount_amount")
  isActive             Boolean @default(true) @map("is_active")
  startDate            DateTime? @map("start_date")
  endDate              DateTime? @map("end_date")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("service_promotions")
}

// Gói dịch vụ (combo)
model Package {
  id             String  @id @default(uuid())
  code           String  @unique @map("package_code")
  name           String  @map("name")
  description    String? @map("description")
  // Giá gói: có thể để null để tính = tổng các item (hoặc set giá riêng)
  price          Float?  @map("price")
  isActive       Boolean @default(true) @map("is_active")
  requiresDoctor Boolean @default(false) @map("requires_doctor")

  // phân loại & khoa (nếu muốn thống kê theo nhóm giống Service)
  categoryId  String?          @map("category_id")
  category    ServiceCategory? @relation(fields: [categoryId], references: [id])
  specialtyId String?          @map("specialty_id")
  specialty   Specialty?       @relation(fields: [specialtyId], references: [id])

  items PackageItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  isDeleted Boolean?  @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@map("packages")
}

// Thành phần gói: liên kết N-N giữa Package và Service, kèm thuộc tính
model PackageItem {
  id            String  @id @default(uuid())
  packageId     String  @map("package_id")
  serviceId     String  @map("service_id")
  quantity      Int     @default(1) @map("quantity")
  priceOverride Float?  @map("price_override") // nếu giá trong gói khác giá lẻ
  required      Boolean @default(true) @map("required") // bắt buộc hay tuỳ chọn
  sortOrder     Int?    @map("sort_order")
  notes         String? @map("notes")

  package Package @relation(fields: [packageId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])

  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@unique([packageId, serviceId])
  @@index([packageId])
  @@index([serviceId])
  @@map("package_items")
}

model ServiceCategory {
  id          String    @id @default(uuid())
  code        String    @unique
  name        String
  description String?
  services    Service[]
  packages    Package[]

  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@map("service_categories")
}

// Bảng Appointment cho lịch hẹn
model Appointment {
  id               String      @id @default(uuid())
  appointmentCode  String      @map("appointment_code")
  patientProfileId String      @map("patient_profile_id")
  specialtyId      String      @map("specialty_id")
  doctorId         String      @map("doctor_id")
  serviceId        String?     @map("service_id")
  bookerId         String?     @map("booker_id")
  status           String      @default("PENDING") @map("status") // PENDING, CONFIRMED, COMPLETED, CANCELLED
  date             DateTime    @map("date")
  startTime        String      @map("start_time")
  endTime          String      @map("end_time")
  workSessionId    String      @map("work_session_id")
  workSession      WorkSession @relation(fields: [workSessionId], references: [id])

  patientProfile       PatientProfile        @relation(fields: [patientProfileId], references: [id])
  specialty            Specialty             @relation(fields: [specialtyId], references: [id])
  doctor               Doctor                @relation(fields: [doctorId], references: [id])
  service              Service?              @relation(fields: [serviceId], references: [id])
  appointmentServices  AppointmentService[]
  prescriptionServices PrescriptionService[]
  medicalRecords       MedicalRecord[]

  @@map("appointments")
}

model AppointmentService {
  appointmentId String
  appointment   Appointment  @relation(fields: [appointmentId], references: [id])
  serviceId     String
  service       Service      @relation(fields: [serviceId], references: [id])
  workSession   WorkSession? @relation(fields: [workSessionId], references: [id])
  workSessionId String?

  @@unique([appointmentId, serviceId])
  @@map("appointment_services")
}

model Invoice {
  id           String @id @default(uuid())
  invoiceCode  String @map("invoice_code")
  totalAmount  Float  @map("total_amount") // Tổng tiền phải thanh toán
  originalTotalAmount Float? @map("original_total_amount") // Tổng giá gốc trước giảm
  totalDiscountAmount Float? @map("total_discount_amount") // Tổng số tiền được giảm
  amountPaid   Float  @default(0) @map("amount_paid") // Số tiền bệnh nhân đã đưa
  changeAmount Float  @default(0) @map("change_amount") // Tiền thối lại cho bệnh nhân

  paymentMethod PaymentMethod @default(CASH) @map("payment_method") // Tiền mặt, thẻ, chuyển khoản...
  paymentStatus String        @map("payment_status") // Pending, Paid, Refunded...
  discountReason String?      @map("discount_reason") // Lý do giảm giá tổng
  createdAt     DateTime      @default(now()) @map("created_at")
  isPaid        Boolean       @default(false) @map("is_paid")

  patientProfileId String
  patientProfile   PatientProfile @relation(fields: [patientProfileId], references: [id])
  cashierId        String
  cashier          Cashier        @relation(fields: [cashierId], references: [id])

  invoiceDetails      InvoiceDetail[]
  paymentTransactions PaymentTransaction[]

  @@map("invoices")
}

enum PaymentMethod {
  CASH
  TRANSFER
}

// Bảng giao dịch thanh toán từ cổng PayOS
model PaymentTransaction {
  id                    String                   @id @default(uuid())
  invoiceId             String                   @map("invoice_id")
  invoice               Invoice                  @relation(fields: [invoiceId], references: [id])
  amount                Float                    @map("amount") // Số tiền yêu cầu thanh toán
  currency              String?                  @map("currency") // VND, USD...
  status                PaymentTransactionStatus @default(PENDING) @map("status")
  providerTransactionId String?                  @map("provider_transaction_id") // Mã giao dịch từ PayOS
  orderCode             String?                  @map("order_code") // Mã đơn hàng để đối chiếu
  paymentUrl            String?                  @map("payment_url")
  qrCode                String?                  @map("qr_code")
  expiredAt             DateTime?                @map("expired_at") // Thời điểm hết hạn thanh toán
  paidAt                DateTime?                @map("paid_at") // Thời điểm PayOS xác nhận đã thanh toán
  lastWebhookPayload    Json?                    @map("last_webhook_payload") // Lưu raw payload lần webhook gần nhất
  lastWebhookStatus     String?                  @map("last_webhook_status") // Kết quả xử lý webhook gần nhất
  lastWebhookAt         DateTime?                @map("last_webhook_at")
  isVerified            Boolean                  @default(false) @map("is_verified") // Đã đối chiếu chữ ký/ checksum chưa
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  @@map("payment_transactions")
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
}

// Bảng chi tiết thông tin thanh toán
model InvoiceDetail {
  id                    String               @id @default(uuid())
  invoiceId             String
  invoice               Invoice              @relation(fields: [invoiceId], references: [id])
  serviceId             String
  service               Service              @relation(fields: [serviceId], references: [id])
  price                 Float                @map("price")
  originalPrice         Float?               @map("original_price")
  discountAmount        Float?               @map("discount_amount")
  discountReason        String?              @map("discount_reason")
  prescriptionId        String?
  prescription          Prescription?        @relation(fields: [prescriptionId], references: [id])
  prescriptionServiceId String?              @map("prescription_service_id")
  prescriptionService   PrescriptionService? @relation(fields: [prescriptionServiceId], references: [id])

  @@unique([invoiceId, prescriptionServiceId])
  @@map("invoice_details")
}

// Bảng Template cho mẫu bệnh án
model Template {
  id             String          @id @default(uuid())
  templateCode   String          @map("template_code")
  name           String // Tên template, ví dụ: "Nội khoa", "Răng hàm mặt"
  fields         Json // Cấu trúc động của template, ví dụ: danh sách fields
  isActive       Boolean         @default(true) // Trạng thái sử dụng
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  specialtyId    String
  specialty      Specialty       @relation(fields: [specialtyId], references: [id])
  medicalRecords MedicalRecord[] // Liên kết với bệnh án sử dụng template này

  @@map("templates")
}

// Bảng MedicalRecord cho bệnh án
model MedicalRecord {
  id                      String                   @id @default(uuid())
  medicalRecordCode       String                   @map("medical_record_code")
  templateId              String
  patientProfileId        String                   @map("patient_profile_id")
  doctorId                String
  appointmentId           String?                  @map("appointment_id") // Có thể null nếu không có appointment
  content                 Json // Nội dung bệnh án theo template
  isActive                Boolean                  @default(true) // Trạng thái sử dụng
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  status                  MedicalRecordStatus      @default(DRAFT)
  histories               MedicalRecordHistory[]
  template                Template                 @relation(fields: [templateId], references: [id])
  patientProfile          PatientProfile           @relation(fields: [patientProfileId], references: [id])
  doctor                  Doctor                   @relation(fields: [doctorId], references: [id])
  appointment             Appointment?             @relation(fields: [appointmentId], references: [id])
  prescriptions           Prescription[]
  medicationPrescriptions MedicationPrescription[]
  doctorRatings           DoctorRating[]

  @@map("medical_records")
}

enum MedicalRecordStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

model MedicalRecordHistory {
  id              String        @id @default(uuid())
  medicalRecordId String
  changedBy       String // UserId
  changedAt       DateTime      @default(now())
  changes         Json // Nội dung thay đổi (có thể lưu diff hoặc toàn bộ snapshot)
  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id])

  @@map("medical_record_histories")
}

// Bảng Phiếu chỉ định => Bác sĩ chỉ định dịch vụ cho bệnh nhân
model Prescription {
  id               String                @id @default(uuid())
  prescriptionCode String                @map("prescription_code")
  doctorId         String?
  doctor           Doctor?               @relation(fields: [doctorId], references: [id])
  // Một phiếu chỉ định có nhiều dịch vụ
  services         PrescriptionService[] @relation("PrescriptionServices")
  patientProfileId String
  patientProfile   PatientProfile        @relation(fields: [patientProfileId], references: [id])
  note             String?
  status           PrescriptionStatus    @default(NOT_STARTED)
  invoiceDetails   InvoiceDetail[]
  medicalRecordId  String?
  medicalRecord    MedicalRecord?        @relation(fields: [medicalRecordId], references: [id])

  // Chỉ định để làm rõ dịch vụ (một Prescription chỉ thuộc về một PrescriptionService)
  belongsToServiceId String? @map("belongs_to_service_id")
  belongsToService PrescriptionService? @relation("IssuedPrescriptions", fields: [belongsToServiceId], references: [id])

  @@map("prescriptions")
}

// Đơn thuốc (Medication Prescription) độc lập với phiếu chỉ định dịch vụ
model MedicationPrescription {
  id               String                       @id @default(uuid())
  code             String                       @unique @map("code")
  doctorId         String                       @map("doctor_id")
  doctor           Doctor                       @relation(fields: [doctorId], references: [id])
  patientProfileId String                       @map("patient_profile_id")
  patientProfile   PatientProfile               @relation(fields: [patientProfileId], references: [id])
  medicalRecordId  String?                      @map("medical_record_id")
  medicalRecord    MedicalRecord?               @relation(fields: [medicalRecordId], references: [id])
  note             String?
  status           MedicationPrescriptionStatus @default(DRAFT)
  createdAt        DateTime                     @default(now()) @map("created_at")
  updatedAt        DateTime                     @updatedAt @map("updated_at")

  items MedicationPrescriptionItem[]

  @@map("medication_prescriptions")
}

enum MedicationPrescriptionStatus {
  DRAFT
  SIGNED
  DISPENSED
  CANCELLED
}

model MedicationPrescriptionItem {
  id             String                 @id @default(uuid())
  prescriptionId String                 @map("prescription_id")
  prescription   MedicationPrescription @relation(fields: [prescriptionId], references: [id])

  name         String
  ndc          String?
  strength     String?
  dosageForm   String? @map("dosage_form")
  route        String?
  dose         Float?  @map("dose")
  doseUnit     String? @map("dose_unit")
  frequency    String?
  durationDays Int?    @map("duration_days")
  quantity     Float?
  quantityUnit String? @map("quantity_unit")
  instructions String?
  drugId       String?
  drug         Drug?   @relation(fields: [drugId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("medication_prescription_items")
}

model Drug {
  id         String  @id @default(uuid())
  name       String
  ndc        String? @unique
  strength   String?
  dosageForm String? @map("dosage_form")
  route      String?
  unit       String?
  source     Json?

  items MedicationPrescriptionItem[]

  @@map("drugs")
}

// Bảng trung gian PrescriptionService cho quan hệ nhiều-nhiều giữa Phiếu chỉ định và Dịch vụ
model PrescriptionService {
  id             String             @id @default(uuid())
  prescriptionId String
  serviceId      String
  prescription   Prescription       @relation("PrescriptionServices", fields: [prescriptionId], references: [id]) 
  service        Service            @relation(fields: [serviceId], references: [id])
  doctorId       String?
  doctor         Doctor?            @relation(fields: [doctorId], references: [id])
  technicianId   String?
  technician     Technician?        @relation(fields: [technicianId], references: [id])
  status         PrescriptionStatus @default(NOT_STARTED)
  results        String[]           @map("results")
  order          Int                @default(1)
  callCount      Int                @default(0)
  skipCount      Int                @default(0)
  appointmentId  String?
  appointment    Appointment?       @relation(fields: [appointmentId], references: [id])
  note           String?
  startedAt      DateTime?          @map("started_at")
  completedAt    DateTime?          @map("completed_at")
  // Danh sách các phiếu chỉ định để phục vụ cho dịch vụ này (lưu dưới dạng array IDs, không dùng relation vì Prisma không hỗ trợ array foreign keys)
  issuedPrescriptionIds String[]            @default([]) @map("issued_prescription_ids")
  
  // Danh sách các phiếu chỉ định được phát hành để làm rõ dịch vụ này (one-to-many: một PrescriptionService có nhiều Prescription)
  issuedPrescriptions Prescription[] @relation("IssuedPrescriptions")

  // Lưu trữ thông tin buồng và phòng thực hiện dịch vụ
  boothId      String?     @map("booth_id")
  booth        Booth?      @relation(fields: [boothId], references: [id])
  clinicRoomId String?     @map("clinic_room_id")
  clinicRoom   ClinicRoom? @relation(fields: [clinicRoomId], references: [id])

  // Lưu trữ work session thực hiện dịch vụ
  workSessionId String?      @map("work_session_id")
  workSession   WorkSession? @relation(fields: [workSessionId], references: [id])

  // Liên kết với chi tiết hóa đơn
  invoiceDetails InvoiceDetail[]

  @@unique([prescriptionId, serviceId])
  @@map("prescription_services")
}

enum PrescriptionStatus {
  // Bác sĩ chỉ định dịch vụ cho bệnh nhân
  NOT_STARTED
  // Dịch vụ đã thanh toán
  PENDING
  // Đang chờ
  WAITING
  // Chuẩn bị thực hiện dịch vụ
  PREPARING
  // Đang thực hiện dịch vụ
  SERVING
  // Chờ kết quả
  WAITING_RESULT
  // Đã thực hiện xong các chỉ định cần thiết và quay lại chờ kết quả
  RETURNING
  COMPLETED
  // Đã gọi bệnh nhân nhưng bệnh nhân không đến
  CANCELLED
  // Đã gọi bệnh nhân nhưng bệnh nhân không đến
  SKIPPED
  // Hẹn tiếp tục thực hiện dịch vụ
  RESCHEDULED
}

model Booth {
  id        String     @id @default(uuid())
  boothCode String     @unique @map("booth_code")
  name      String     @map("name")
  roomId    String
  room      ClinicRoom @relation(fields: [roomId], references: [id])

  description          String?               @map("description")
  isActive             Boolean               @default(true) @map("is_active")
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  workSessions         WorkSession[]
  boothServices        BoothService[]
  prescriptionServices PrescriptionService[]

  isDeleted Boolean?  @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@map("booths")
}

model WorkSession {
  id                   String                @id @default(uuid())
  boothId              String?
  booth                Booth?                @relation(fields: [boothId], references: [id])
  doctorId             String?
  doctor               Doctor?               @relation(fields: [doctorId], references: [id])
  technicianId         String?
  technician           Technician?           @relation(fields: [technicianId], references: [id])
  startTime            DateTime              @map("start_time")
  endTime              DateTime              @map("end_time")
  nextAvailableAt      DateTime?             @map("next_available_at")
  status               WorkSessionStatus     @default(PENDING)
  services             WorkSessionService[]
  appointmentServices  AppointmentService[]
  appointments         Appointment[]
  prescriptionServices PrescriptionService[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_sessions")
}

model WorkSessionService {
  workSessionId String
  workSession   WorkSession @relation(fields: [workSessionId], references: [id])
  serviceId     String
  service       Service     @relation(fields: [serviceId], references: [id])

  @@unique([workSessionId, serviceId])
  @@map("work_session_services")
}

enum WorkSessionStatus {
  PENDING
  APPROVED
  IN_PROGRESS
  CANCELED
  COMPLETED
}

model Certificate {
  id          String          @id @default(uuid())
  code        String?         @unique @map("code") // Mã chứng chỉ nội bộ (nếu có)
  title       String          @map("title") // Tên chứng chỉ / văn bằng
  type        CertificateType @map("type") // Loại: LICENSE / DEGREE / TRAINING / OTHER
  issuedBy    String?         @map("issued_by") // Cơ quan / tổ chức cấp
  issuedAt    DateTime?       @map("issued_at") // Ngày cấp
  expiryAt    DateTime?       @map("expiry_at") // Ngày hết hạn (nếu có)
  file        String?         @map("file") // URL hoặc path ảnh / file scan chứng chỉ
  description String?         @map("description") // Mô tả ngắn hoặc ghi chú

  // Chỉ liên kết tới Doctor hoặc Technician
  doctorId String? @map("doctor_id")
  doctor   Doctor? @relation(fields: [doctorId], references: [id])

  technicianId String?     @map("technician_id")
  technician   Technician? @relation(fields: [technicianId], references: [id])

  @@map("certificates")
}

enum CertificateType {
  LICENSE // Chứng chỉ hành nghề
  DEGREE // Văn bằng (ĐH, ThS, TS,…)
  TRAINING // Chứng nhận đào tạo, workshop, khóa học
  OTHER // Loại khác (ví dụ: giải thưởng, vinh danh,...)
}

// Bảng đánh giá bác sĩ từ bệnh nhân
model DoctorRating {
  id        String   @id @default(uuid())
  doctorId  String   @map("doctor_id")
  patientId String   @map("patient_id")
  medicalRecordId String @map("medical_record_id")
  rating    Int      @map("rating") // 1-5 sao
  comment   String?  @map("comment") // Bình luận của bệnh nhân
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)

  @@unique([medicalRecordId, patientId]) // Mỗi patient chỉ đánh giá 1 lần cho 1 hồ sơ khám
  @@index([doctorId])
  @@index([patientId])
  @@index([medicalRecordId])
  @@index([rating])
  @@map("doctor_ratings")
}

// ====================== POST & STATUS ======================
model Post {
  id         String        @id @default(uuid())
  title      String
  slug       String        @unique @map("slug")
  coverImage String?       @map("cover_image")
  summary    String?
  content    String?
  authorId   String        @map("author_id")
  author     Admin         @relation(fields: [authorId], references: [id])
  status     ContentStatus @default(DRAFT)
  isPinned   Boolean       @default(false) @map("is_pinned")
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  tags       String[]      @map("tags")

  // N–N explicit với Category
  inCategories PostInCategory[]

  // N–N explicit với Series (có thứ tự)
  seriesPosts SeriesPost[]

  // Bình luận & lượt thích
  comments Comment[]
  likes    PostLike[]

  @@map("posts")
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  UNPUBLISHED
}

// ====================== CATEGORY ======================
model PostCategory {
  id              String           @id @default(uuid())
  name            String
  slug            String           @unique @map("slug")
  coverImage      String?          @map("cover_image")
  description     String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime?        @updatedAt
  authorId        String?          @map("author_id")
  author          Admin?           @relation(fields: [authorId], references: [id])
  status          ContentStatus    @default(DRAFT)
  postsInCategory PostInCategory[]

  @@map("post_categories")
}

// Bảng nối Post ↔ Category (đặt tên rõ ràng)
model PostInCategory {
  postId     String @map("post_id")
  categoryId String @map("category_id")

  post     Post         @relation(fields: [postId], references: [id])
  category PostCategory @relation(fields: [categoryId], references: [id])

  @@id([postId, categoryId])
  @@index([categoryId])
  @@map("posts_categories")
}

// ====================== SERIES ======================
model Series {
  id          String        @id @default(uuid())
  name        String
  coverImage  String?       @map("cover_image")
  authorId    String?       @map("author_id")
  author      Admin?        @relation(fields: [authorId], references: [id])
  slug        String        @unique @map("slug")
  status      ContentStatus @default(DRAFT)
  description String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  seriesPosts SeriesPost[]

  @@map("series")
}

// Bảng nối Series ↔ Post (có thứ tự)
model SeriesPost {
  seriesId String @map("series_id")
  postId   String @map("post_id")
  order    Int    @map("order_in_series")

  series Series @relation(fields: [seriesId], references: [id])
  post   Post   @relation(fields: [postId], references: [id])

  @@id([seriesId, postId])
  @@index([postId])
  @@map("series_posts")
}

// ====================== COMMENTS ======================
model Comment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  parentId  String?  @map("parent_id")
  authorId  String   @map("author_id")
  content   String
  isEdited  Boolean  @default(false) @map("is_edited")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan hệ
  post    Post      @relation(fields: [postId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")
  author  Auth      @relation(fields: [authorId], references: [id])

  likes CommentLike[]

  @@index([postId])
  @@index([parentId])
  @@index([authorId])
  @@map("comments")
}

// ====================== LIKES ======================
// Like bài viết
model PostLike {
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  post Post @relation(fields: [postId], references: [id])
  user Auth @relation(fields: [userId], references: [id])

  @@id([postId, userId])
  @@index([userId])
  @@map("post_likes")
}

// Like bình luận
model CommentLike {
  commentId String   @map("comment_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  comment Comment @relation(fields: [commentId], references: [id])
  user    Auth    @relation(fields: [userId], references: [id])

  @@id([commentId, userId])
  @@index([userId])
  @@map("comment_likes")
}
