// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "darwin-arm64"]

}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Định nghĩa enum cho các vai trò
enum Role {
  DOCTOR
  PATIENT
  RECEPTIONIST
  ADMIN
  CASHIER
  TECHNICIAN
}

// Bảng Auth cho thông tin đăng nhập và thông tin cơ bản
model Auth {
  id           String      @id @default(uuid())
  phone        String?     @unique
  email        String?     @unique
  googleId     String?     @unique @map("google_id") // Lưu ID từ Google
  password     String?
  accessToken  String?     @map("access_token") // Lưu access token từ Google 
  refreshToken String?     @map("refresh_token") // Lưu refresh token để làm mới access token
  tokenExpiry  DateTime?   @map("token_expiry") // Thời gian hết hạn của access token
  // Thông tin cơ bản từ User
  name         String
  dateOfBirth  DateTime    @map("date_of_birth") 
  gender       String
  avatar       String?
  address      String
  citizenId    String?     @unique @map("citizen_id") // Số CMND/CCCD - có thể null
  role         Role
  // Quan hệ với các bảng chuyên biệt
  doctor       Doctor?
  patient      Patient?
  receptionist Receptionist?
  admin        Admin?
  cashier      Cashier?
  technician   Technician?
  @@map("auths")
}

// Bảng Technician cho kỹ thuật viên
model Technician {
  id       String      @id @default(uuid())
  technicianCode String @unique @map("technician_code")
  authId   String      @unique @map("auth_id")
  auth     Auth        @relation(fields: [authId], references: [id])
  workSessions WorkSession[]
  prescriptionServices PrescriptionService[]

  @@map("technicians")
}

// Bảng Doctor cho thông tin bác sĩ
model Doctor {
  id              String      @id @default(uuid())
  doctorCode      String      @unique @map("doctor_code")
  authId          String      @unique @map("auth_id")
  degrees         Json     // Sửa từ String[] sang Json
  yearsExperience Int      @map("years_experience")
  rating          Float    @map("rating")
  workHistory     String   @map("work_history")
  description     String   @map("description")
  auth            Auth     @relation(fields: [authId], references: [id])
  appointments    Appointment[]
  medicalRecords  MedicalRecord[]
  prescriptions   Prescription[]
  workSessions WorkSession[]
  prescriptionServices PrescriptionService[]

  @@map("doctors")
}

// Bảng Patient cho thông tin bệnh nhân (người đăng ký)
model Patient {
  id                String      @id @default(uuid())
  patientCode       String      @map("patient_code")
  authId            String?     @unique @map("auth_id")
  auth              Auth?       @relation(fields: [authId], references: [id])
  loyaltyPoints     Int         @default(0) @map("loyalty_points") // Điểm thưởng
  patientProfiles   PatientProfile[] // Quan hệ với các hồ sơ khám bệnh (có thể null)

  @@map("patients")
}

// Bảng PatientProfile cho hồ sơ khám bệnh của từng người (độc lập)
model PatientProfile {
  id                String      @id @default(uuid())
  profileCode       String      @map("profile_code")
  patientId         String?     @map("patient_id") // Có thể null - không bắt buộc phải có Patient
  name              String      // Tên người khám
  phone             String?     // Số điện thoại của người khám (có thể trùng)
  dateOfBirth       DateTime    @map("date_of_birth")
  gender            String
  address           String?
  occupation        String?     @map("occupation") // Nghề nghiệp
  emergencyContact  Json        @map("emergency_contact") // Liên hệ khẩn cấp
  healthInsurance   String?     @map("health_insurance") // Bảo hiểm y tế
  relationship      String?     // Mối quan hệ với người đăng ký (ba, mẹ, con, vợ, chồng, ...)
  isActive          Boolean     @default(true) @map("is_active")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  patient           Patient?    @relation(fields: [patientId], references: [id]) // Quan hệ optional
  appointments      Appointment[]
  medicalRecords    MedicalRecord[]
  prescriptions   Prescription[]
  invoices        Invoice[]
  @@map("patient_profiles")
}

// Bảng Receptionist cho lễ tân/phụ tá
model Receptionist {
  id       String      @id @default(uuid())
  authId   String      @unique @map("auth_id")
  auth     Auth        @relation(fields: [authId], references: [id])
  counters Counter[]    // Quan hệ với các counter

  @@map("receptionists")
}

// Bảng Counter cho quầy khám
model Counter {
  id          String      @id @default(uuid())
  counterCode String      @unique @map("counter_code") // Mã quầy: CTR001, CTR002,...
  counterName String      @map("counter_name") // Tên quầy: Quầy 1, Quầy 2,...
  location    String?     @map("location") // Vị trí: Tầng 1, Tầng 2,...
  isActive    Boolean     @default(true) @map("is_active")
  maxQueue    Int         @default(10) @map("max_queue") // Số lượng tối đa trong queue
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  receptionistId String?  @map("receptionist_id") // Có thể null khi không có receptionist
  receptionist   Receptionist? @relation(fields: [receptionistId], references: [id])
  
  // Quan hệ với queue và assignments
  queueItems    CounterQueueItem[]
  assignments   CounterAssignment[]

  @@map("counters")
}

// Bảng CounterQueueItem để lưu queue của từng counter
model CounterQueueItem {
  id          String      @id @default(uuid())
  counterId   String      @map("counter_id")
  appointmentId String    @map("appointment_id")
  patientName String      @map("patient_name")
  priorityScore Int       @map("priority_score")
  estimatedWaitTime Int   @map("estimated_wait_time") // phút
  assignedAt  DateTime    @default(now()) @map("assigned_at")
  status      String      @default("WAITING") // WAITING, CALLED, COMPLETED, CANCELLED
  
  counter     Counter     @relation(fields: [counterId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id])

  @@map("counter_queue_items")
}

// Bảng CounterAssignment để lưu lịch sử phân bổ
model CounterAssignment {
  id          String      @id @default(uuid())
  counterId   String      @map("counter_id")
  appointmentId String    @map("appointment_id")
  patientName String      @map("patient_name")
  priorityScore Int       @map("priority_score")
  assignedAt  DateTime    @default(now()) @map("assigned_at")
  completedAt DateTime?   @map("completed_at")
  
  counter     Counter     @relation(fields: [counterId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id])

  @@map("counter_assignments")
}

// Bảng Admin cho admin phòng khám
model Admin {
  id       String      @id @default(uuid())
  adminCode String     @map("admin_code")
  authId   String      @unique @map("auth_id")
  auth     Auth        @relation(fields: [authId], references: [id])

  @@map("admins")
}

// Nhân viên thu ngân
model Cashier {
  id       String      @id @default(uuid())
  authId   String      @unique @map("auth_id")
  auth     Auth        @relation(fields: [authId], references: [id])
  invoices Invoice[]
  @@map("cashiers")
}

// Bảng Specialty cho chuyên khoa
model Specialty {
  id          String      @id @default(uuid()) @map("id")
  specialtyCode String      @unique @map("specialty_code")
  name        String
  clinicRooms ClinicRoom[]
  appointments Appointment[]
  templates   Template[]

  @@map("specialties")
}

// Bảng ClinicRoom cho phòng khám
model ClinicRoom {
  id          String      @id @default(uuid())
  roomCode    String      @unique @map("room_code") // Mã phòng
  roomName    String      @map("room_name") // Tên phòng
  specialtyId String      @map("specialty_id")
  description String?     @map("description") // Mô tả phòng
  address     String?     @map("address") // Địa chỉ phòng
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  booth Booth[]
  appointments Appointment[]

  specialty   Specialty   @relation(fields: [specialtyId], references: [id])
  services    ClinicRoomService[]

  @@map("clinic_rooms")
}

// Bảng trung gian ClinicRoomService cho quan hệ nhiều-nhiều giữa phòng khám và dịch vụ
model ClinicRoomService {
  clinicRoomId String      @map("clinic_room_id")
  serviceId    String      @map("service_id")
  clinicRoom   ClinicRoom  @relation(fields: [clinicRoomId], references: [id])
  service      Service     @relation(fields: [serviceId], references: [id])
  
  @@unique([clinicRoomId, serviceId])
  @@map("clinic_room_services")
}

model Service {
  id          String      @id @default(uuid())
  serviceCode String      @unique @map("service_code")
  name        String      @map("name")
  price       Float?        @map("price")
  description String       @map("description")
  timePerPatient Int?       @default(15) @map("time_per_patient") @db.SmallInt
  isAllowed Boolean        @default(false) @map("is_allowed")

  // Quan hệ cha–con
  parentId   String?       @map("parent_id")
  parent     Service?      @relation("ServiceHierarchy", fields: [parentId], references: [id])
  children   Service[]     @relation("ServiceHierarchy")

  // Các quan hệ hiện có
  clinicRoomServices ClinicRoomService[]
  prescriptions PrescriptionService[]
  invoiceDetails InvoiceDetail[]
  workSessionServices WorkSessionService[]
  appointmentServices AppointmentService[]
  appointments Appointment[]

  @@map("services")
}

// Bảng Appointment cho lịch hẹn
model Appointment {
  id          String      @id @default(uuid())
  appointmentCode String   @map("appointment_code")
  patientProfileId String  @map("patient_profile_id")
  specialtyId String      @map("specialty_id")
  doctorId    String      @map("doctor_id")
  clinicRoomId String?    @map("clinic_room_id") // Phòng khám (có thể null)
  serviceId   String?     @map("service_id") // Dịch vụ chính (có thể null)
  bookerId    String?     @map("booker_id") // Người đặt lịch (có thể null)
  status      String      @default("PENDING") @map("status") // PENDING, CONFIRMED, COMPLETED, CANCELLED
  date        DateTime    @map("date")
  startTime   String      @map("start_time")
  endTime     String      @map("end_time")

  patientProfile PatientProfile @relation(fields: [patientProfileId], references: [id])
  specialty   Specialty @relation(fields: [specialtyId], references: [id])
  doctor      Doctor   @relation(fields: [doctorId], references: [id])
  clinicRoom  ClinicRoom? @relation(fields: [clinicRoomId], references: [id])
  service     Service? @relation(fields: [serviceId], references: [id])
  appointmentServices AppointmentService[]
  medicalRecords MedicalRecord[]

  counterQueueItems CounterQueueItem[]
  counterAssignments CounterAssignment[]

  @@map("appointments")
}

model AppointmentService {
  appointmentId String
  appointment Appointment @relation(fields: [appointmentId], references: [id])
  serviceId String
  service Service @relation(fields: [serviceId], references: [id])
  workSession WorkSession? @relation(fields: [workSessionId], references: [id])
  workSessionId String?
  @@unique([appointmentId, serviceId])
  @@map("appointment_services")
}

model Invoice {
  id              String      @id @default(uuid())
  invoiceCode     String      @map("invoice_code")
  totalAmount     Float       @map("total_amount")           // Tổng tiền phải thanh toán
  amountPaid      Float       @default(0) @map("amount_paid") // Số tiền bệnh nhân đã đưa
  changeAmount    Float       @default(0) @map("change_amount") // Tiền thối lại cho bệnh nhân

  paymentMethod   String      @map("payment_method")          // Tiền mặt, thẻ, chuyển khoản...
  paymentStatus   String      @map("payment_status")           // Pending, Paid, Refunded...
  createdAt       DateTime    @default(now()) @map("created_at")
  isPaid           Boolean     @default(false) @map("is_paid")

  patientProfileId String
  patientProfile    PatientProfile @relation(fields: [patientProfileId], references: [id])
  cashierId          String
  cashier             Cashier @relation(fields: [cashierId], references: [id])

  invoiceDetails      InvoiceDetail[]

  @@map("invoices")
}


// Bảng chi tiết thông tin thanh toán
model InvoiceDetail {
  invoiceId String
  invoice Invoice @relation(fields: [invoiceId], references: [id])
  serviceId String
  service Service @relation(fields: [serviceId], references: [id])
  price Float @map("price")
  prescriptionId String?
  prescription Prescription? @relation(fields: [prescriptionId], references: [id])

  @@unique([invoiceId, serviceId])
  @@map("invoice_details")
}

// Bảng Template cho mẫu bệnh án
model Template {
  id          String      @id @default(uuid())
  templateCode String   @map("template_code")
  name        String   // Tên template, ví dụ: "Nội khoa", "Răng hàm mặt"
  fields      Json     // Cấu trúc động của template, ví dụ: danh sách fields
  isActive    Boolean  @default(true) // Trạng thái sử dụng
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  specialtyId String
  specialty   Specialty @relation(fields: [specialtyId], references: [id])
  medicalRecords MedicalRecord[] // Liên kết với bệnh án sử dụng template này

  @@map("templates")
}

// Bảng MedicalRecord cho bệnh án
model MedicalRecord {
  id          String      @id @default(uuid())
  medicalRecordCode String   @map("medical_record_code")
  templateId  String
  patientProfileId String  @map("patient_profile_id")
  doctorId    String
  appointmentId String?   @map("appointment_id") // Có thể null nếu không có appointment
  content     Json     // Nội dung bệnh án theo template
  isActive    Boolean  @default(true) // Trạng thái sử dụng
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  status      MedicalRecordStatus @default(DRAFT)
  histories   MedicalRecordHistory[]
  template    Template @relation(fields: [templateId], references: [id])
  patientProfile PatientProfile @relation(fields: [patientProfileId], references: [id])
  doctor      Doctor   @relation(fields: [doctorId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  prescriptions Prescription[]

  @@map("medical_records")
}

enum MedicalRecordStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

model MedicalRecordHistory {
  id              String   @id @default(uuid())
  medicalRecordId String
  changedBy       String   // UserId
  changedAt       DateTime @default(now())
  changes         Json     // Nội dung thay đổi (có thể lưu diff hoặc toàn bộ snapshot)
  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id])
}

// Bảng Phiếu chỉ định => Bác sĩ chỉ định dịch vụ cho bệnh nhân
model Prescription {
  id          String      @id @default(uuid())
  prescriptionCode String   @map("prescription_code")
  doctorId String?
  doctor Doctor? @relation(fields: [doctorId], references: [id])
  services PrescriptionService[]
  patientProfileId String
  patientProfile PatientProfile @relation(fields: [patientProfileId], references: [id])
  note String?
  status PrescriptionStatus @default(NOT_STARTED)
  invoiceDetails InvoiceDetail[]
  medicalRecordId String?
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@map("prescriptions")
}

// Bảng trung gian PrescriptionService cho quan hệ nhiều-nhiều giữa Phiếu chỉ định và Dịch vụ
model PrescriptionService {
  prescriptionId String
  serviceId String
  prescription Prescription @relation(fields: [prescriptionId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])
  doctorId String?
  doctor Doctor? @relation(fields: [doctorId], references: [id])
  technicianId String?
  technician Technician? @relation(fields: [technicianId], references: [id])
  status PrescriptionStatus @default(NOT_STARTED)
  results String[] @map("results")
  order Int @default(1)
  note String?
  startedAt DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  @@unique([prescriptionId, serviceId])
  @@map("prescription_services")
}

enum PrescriptionStatus {
  NOT_STARTED
  PENDING
  WAITING
  PREPARING
  SERVING
  WAITING_RESULT
  COMPLETED
  DELAYED
  CANCELLED
  SKIPPED
  RECALL_FIRST
  RECALL_SECOND
  RECALL_THIRD
  RECALL_BACK
}

model Booth {
  id String @id @default(uuid())
  boothCode String @unique @map("booth_code")
  name String @map("name")
  roomId String
  room ClinicRoom @relation(fields: [roomId], references: [id])

  description String? @map("description")
  isActive Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  workSessions WorkSession[]
}

model WorkSession {
  id String @id @default(uuid())
  boothId String?
  booth Booth? @relation(fields: [boothId], references: [id])
  doctorId String?
  doctor Doctor? @relation(fields: [doctorId], references: [id])
  technicianId String?
  technician Technician? @relation(fields: [technicianId], references: [id])
  startTime DateTime @map("start_time")
  endTime DateTime @map("end_time")
  nextAvailableAt DateTime? @map("next_available_at")
  status WorkSessionStatus @default(PENDING)
  services WorkSessionService[]
  appointmentServices AppointmentService[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_sessions")
}

model WorkSessionService {
  workSessionId String
  workSession WorkSession @relation(fields: [workSessionId], references: [id])
  serviceId String
  service Service @relation(fields: [serviceId], references: [id])

  @@unique([workSessionId, serviceId])
  @@map("work_session_services")
}

enum WorkSessionStatus {
  PENDING  
  APPROVED          
  IN_PROGRESS          
  CANCELED                
  COMPLETED         
}